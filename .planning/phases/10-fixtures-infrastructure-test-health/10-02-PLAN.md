---
phase: 10-fixtures-infrastructure-test-health
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - test/fixtures/canonical/commands/groom-docs.md
  - test/fixtures/canonical/commands/obs-jot.md
  - test/fixtures/canonical/agents/test-agent.md
  - test/fixtures/canonical/agents/simple-agent.md
  - test/fixtures/canonical/mcp/tavily.json
  - test/fixtures/canonical/mcp/context7.json
  - test/fixtures/canonical/settings/claude.json
  - test/fixtures/canonical/settings/opencode.json
  - test/fixtures/canonical/skills/obsidian/SKILL.md
  - test/fixtures/canonical/skills/web-design-guidelines/SKILL.md
  - test/fixtures/canonical/instructions/AGENTS.md
  - test/helpers/backup.ts
autonomous: true
requirements:
  - FIX-01
  - FIX-02
  - FIX-04
  - FIX-05
  - FIX-06
  - FIX-07

must_haves:
  truths:
    - "`test/fixtures/canonical/` contains fixture files for all 6 config types"
    - "Canonical fixtures exercise format-specific features (frontmatter, TOML, JSONC, flat markdown)"
    - "`withBackup` utility backs up directory trees and restores even on test failure"
    - "Agents fixtures exist (synthetic — real `configs/agents/` is empty)"
  artifacts:
    - path: "test/fixtures/canonical/commands/groom-docs.md"
      provides: "Command fixture with frontmatter description"
    - path: "test/fixtures/canonical/commands/obs-jot.md"
      provides: "Command fixture with multi-line frontmatter"
    - path: "test/fixtures/canonical/agents/test-agent.md"
      provides: "Agent fixture with frontmatter (name, description, allowed-tools)"
    - path: "test/fixtures/canonical/agents/simple-agent.md"
      provides: "Minimal agent fixture (no allowed-tools)"
    - path: "test/fixtures/canonical/mcp/tavily.json"
      provides: "MCP fixture — stdio transport with env_vars"
    - path: "test/fixtures/canonical/mcp/context7.json"
      provides: "MCP fixture — http transport with headers"
    - path: "test/fixtures/canonical/settings/claude.json"
      provides: "Settings fixture — Claude format (env + permissions)"
    - path: "test/fixtures/canonical/settings/opencode.json"
      provides: "Settings fixture — OpenCode format (providers + permissions)"
    - path: "test/fixtures/canonical/skills/obsidian/SKILL.md"
      provides: "Skill fixture with support files"
    - path: "test/fixtures/canonical/skills/web-design-guidelines/SKILL.md"
      provides: "Simple skill fixture (no support files)"
    - path: "test/fixtures/canonical/instructions/AGENTS.md"
      provides: "Instructions fixture — flat markdown"
    - path: "test/helpers/backup.ts"
      provides: "withBackup directory backup/restore utility"
  key_links:
    - from: "test/helpers/backup.ts"
      to: "node:fs"
      via: "cpSync/rmSync for directory tree backup/restore"
      pattern: "cpSync|rmSync"
---

<objective>
Create committed canonical fixture files for all 6 config types and the `withBackup` test harness.

Purpose: FIX-01 through FIX-07 require fixture infrastructure. This plan creates the canonical input fixtures (derived from real configs per CONTEXT.md decision) and the backup/restore utility that Phases 11-12 will use for safe E2E testing against real target directories.
Output: `test/fixtures/canonical/` with all 6 types, `test/helpers/backup.ts` with `withBackup` utility
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@configs/commands/groom-docs.md
@configs/commands/obs-jot.md
@configs/mcp/tavily.json
@configs/mcp/context7.json
@configs/settings/claude.json
@configs/settings/opencode.json
@configs/skills/obsidian/SKILL.md
@configs/skills/web-design-guidelines/SKILL.md
@configs/instructions/AGENTS.md
@src/core/rollback.ts
@src/adapters/path-resolver.ts
@src/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create canonical fixture files for all 6 config types</name>
  <files>
    test/fixtures/canonical/commands/groom-docs.md,
    test/fixtures/canonical/commands/obs-jot.md,
    test/fixtures/canonical/agents/test-agent.md,
    test/fixtures/canonical/agents/simple-agent.md,
    test/fixtures/canonical/mcp/tavily.json,
    test/fixtures/canonical/mcp/context7.json,
    test/fixtures/canonical/settings/claude.json,
    test/fixtures/canonical/settings/opencode.json,
    test/fixtures/canonical/skills/obsidian/SKILL.md,
    test/fixtures/canonical/skills/web-design-guidelines/SKILL.md,
    test/fixtures/canonical/instructions/AGENTS.md
  </files>
  <action>
  Create `test/fixtures/canonical/` with subdirectories for all 6 config types. Per CONTEXT.md: fixtures are derived from real configs (not synthetic) with 2-3 per type for variation coverage.

  **Directory structure:**
  ```
  test/fixtures/canonical/
    commands/
      groom-docs.md          — copy from configs/commands/groom-docs.md (has frontmatter description)
      obs-jot.md             — copy from configs/commands/obs-jot.md (has multi-line description via >-)
    agents/
      test-agent.md          — NEW synthetic (configs/agents/ is empty). Frontmatter: name, description, allowed-tools list. Body: agent instructions markdown with ## sections.
      simple-agent.md        — NEW synthetic. Minimal: frontmatter with name + description only, short body. Tests agents without allowed-tools.
    mcp/
      tavily.json            — copy from configs/mcp/tavily.json (stdio transport, env_vars, env object)
      context7.json          — copy from configs/mcp/context7.json (http transport, headers, url)
    settings/
      claude.json            — copy from configs/settings/claude.json (env + permissions structure)
      opencode.json          — TRIMMED from configs/settings/opencode.json (keep structure but reduce providers to 1 for fixture size — keep throttle-tux only, and permission section)
    skills/
      obsidian/SKILL.md      — TRIMMED from configs/skills/obsidian/SKILL.md (keep first ~50 lines — frontmatter + vault layout + enough body to test rendering)
      web-design-guidelines/SKILL.md — copy from configs/skills/web-design-guidelines/SKILL.md (simple skill, no support files)
    instructions/
      AGENTS.md              — TRIMMED from configs/instructions/AGENTS.md (keep first ~30 lines — header + core content, enough to test passthrough rendering)
  ```

  **Format-specific feature coverage (FIX-07):**
  - Frontmatter: commands (description key), agents (name + description + allowed-tools), skills (name + description + metadata)
  - JSONC: not in canonical (canonical uses plain JSON) — JSONC is a target format (OpenCode MCP)
  - TOML: not in canonical — TOML is a target format (Gemini commands, Codex MCP)
  - Flat markdown: instructions (no frontmatter)
  - JSON with env vars: MCP fixtures have `${VAR}` syntax, settings have nested objects
  - Multi-line frontmatter: obs-jot uses `>-` YAML syntax

  **Synthetic agent fixtures** (since configs/agents/ is empty):

  `test-agent.md`:
  ```markdown
  ---
  name: test-agent
  description: A test agent for fixture validation
  allowed-tools:
    - Read
    - Write
    - Bash
  ---

  # Test Agent

  You are a test agent used for fixture validation in acsync's test suite.

  ## Capabilities

  - Read and write files
  - Execute bash commands
  - Validate fixture data

  ## Instructions

  Follow the user's instructions carefully.
  ```

  `simple-agent.md`:
  ```markdown
  ---
  name: simple-agent
  description: Minimal agent with no tool restrictions
  ---

  # Simple Agent

  A minimal agent for testing basic agent rendering.
  ```

  All files are committed to git as golden source fixtures.
  </action>
  <verify>`ls -R test/fixtures/canonical/` shows all 6 type directories with files. `find test/fixtures/canonical -type f | wc -l` returns 11 files.</verify>
  <done>Canonical fixture directory exists with all 6 config types, 11 files total, covering frontmatter, JSON, env vars, and flat markdown variations.</done>
</task>

<task type="auto">
  <name>Task 2: Create withBackup test harness utility</name>
  <files>test/helpers/backup.ts</files>
  <action>
  Create `test/helpers/backup.ts` with a `withBackup` utility function that backs up directory trees before test execution and restores them after, even on failure.

  **API signature:**
  ```typescript
  export async function withBackup(dirs: string[], fn: () => Promise<void>): Promise<void>
  ```

  **Implementation:**
  1. For each directory in `dirs`:
     - If directory exists: `cpSync(dir, backupDir, { recursive: true })` to a temp location
     - If directory doesn't exist: record as "did not exist" (restore = delete)
     - Backup location: `mkdtempSync(join(tmpdir(), 'acsync-test-backup-'))` + `/` + sanitized dir name
  2. Run `fn()` inside try/finally
  3. In finally block, for each directory:
     - If had backup: `rmSync(dir, { recursive: true, force: true })` then `cpSync(backupDir, dir, { recursive: true })`
     - If didn't exist: `rmSync(dir, { recursive: true, force: true })`
     - Clean up temp backup dir
  4. If `fn()` threw, re-throw after restore completes

  **Key requirements per CONTEXT.md:**
  - Per test file (suite) isolation — designed for use in `beforeAll`/`afterAll` or wrapping entire describe blocks
  - try/finally pattern for reliable restoration (FIX-06)
  - Backs up real target dirs AND canonical configs/ (FIX-04, FIX-05)
  - Uses `node:fs` `cpSync`/`rmSync` — no dependency on production rollback.ts (test infra stays independent)

  **Also export convenience constants:**
  ```typescript
  import os from 'node:os';
  import path from 'node:path';

  export const TARGET_DIRS = [
    path.join(os.homedir(), '.claude'),
    path.join(os.homedir(), '.config', 'opencode'),
    path.join(os.homedir(), '.gemini'),
    path.join(os.homedir(), '.codex'),
  ];
  ```

  **Also export a higher-level helper for common pattern:**
  ```typescript
  export async function withTargetBackup(fn: () => Promise<void>): Promise<void> {
    return withBackup(TARGET_DIRS, fn);
  }
  ```

  Use `import { cpSync, rmSync, mkdtempSync, existsSync } from 'node:fs'` and `import { tmpdir } from 'node:os'`. All Bun-compatible Node APIs.

  Handle edge cases:
  - Backup dir name collision: use unique tmpdir per call via `mkdtempSync`
  - Partial restore failure: catch per-dir, log warning, continue restoring remaining dirs
  - Nested dirs (e.g., `~/.config/opencode` where `~/.config` exists but `opencode/` might not): check existence at the exact path level
  </action>
  <verify>Create a quick inline test: `bun test test/helpers/` (or run the smoke test in Plan 03). Manually verify the file exports `withBackup`, `withTargetBackup`, and `TARGET_DIRS`.</verify>
  <done>`test/helpers/backup.ts` exists with `withBackup(dirs, fn)` that reliably backs up and restores directory trees in a try/finally pattern.</done>
</task>

</tasks>

<verification>
1. `ls -R test/fixtures/canonical/` — all 6 type dirs with files
2. `test/helpers/backup.ts` exists and exports `withBackup`, `withTargetBackup`, `TARGET_DIRS`
3. `bun test` still passes (no regressions from new files)
4. `git status` shows new files ready to commit
</verification>

<success_criteria>
- `test/fixtures/canonical/` committed with all 6 config types
- Fixture files derive from real configs (per CONTEXT.md decision)
- Agent fixtures are synthetic but realistic (since real configs/agents/ is empty)
- `withBackup` utility handles backup, restore, and cleanup with try/finally
- Format-specific features exercised: frontmatter, JSON env vars, flat markdown, multi-line YAML
</success_criteria>

<output>
After completion, create `.planning/phases/10-fixtures-infrastructure-test-health/10-02-SUMMARY.md`
</output>
