---
phase: 10-fixtures-infrastructure-test-health
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/cli/__tests__/orchestrator.test.ts
  - src/cli/__tests__/stale-and-pull.test.ts
autonomous: true
requirements:
  - HLTH-01
  - HLTH-02

must_haves:
  truths:
    - "`bun test` exits 0 with zero failures"
    - "`package.json` has a `test` script that runs `bun test`"
  artifacts:
    - path: "package.json"
      provides: "test script entry"
      contains: '"test"'
    - path: "src/cli/__tests__/orchestrator.test.ts"
      provides: "Fixed dry-run JSON test"
    - path: "src/cli/__tests__/stale-and-pull.test.ts"
      provides: "Fixed pullAll JSON test"
  key_links:
    - from: "package.json"
      to: "bun test"
      via: "scripts.test"
      pattern: '"test":\\s*"bun test"'
---

<objective>
Fix 2 failing tests and add package.json test script — establish green baseline before any fixture work.

Purpose: HLTH-01 requires zero test failures. HLTH-02 requires `bun test` via package.json. This is the first thing to land so all subsequent plans build on a passing suite.
Output: Green test suite, `bun test` runnable via `package.json` scripts
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@package.json
@src/cli/__tests__/orchestrator.test.ts
@src/cli/__tests__/stale-and-pull.test.ts
@src/cli/push.ts
@src/cli/pull.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix 2 failing tests (JSON parse errors)</name>
  <files>src/cli/__tests__/orchestrator.test.ts, src/cli/__tests__/stale-and-pull.test.ts</files>
  <action>
  Two tests fail because they call `JSON.parse(result.output)` but the functions return pretty-formatted text (not JSON) when `json: true` is not passed.

  **orchestrator.test.ts line ~196** — `test('dry-run output is valid JSON')`:
  The `runPush()` call passes `{ projectDir: tmpDir, dryRun: true, targets: ['claude-code'] }` but omits `json: true`. The pretty flag defaults to `!options.json` which is `!undefined = true`, producing pretty text. Fix: add `json: true` to the options object.

  **stale-and-pull.test.ts line ~324** — `test('JSON output includes source field')`:
  The `runPullAll()` call passes `{ dryRun: true, projectDir: tmpDir }` but omits `json: true`. Same root cause — pretty output produced instead of JSON. Fix: add `json: true` to the options object.

  Both fixes are single-line additions. Do NOT change any production code — these are test bugs (wrong options).
  </action>
  <verify>`bun test src/cli/__tests__/orchestrator.test.ts` and `bun test src/cli/__tests__/stale-and-pull.test.ts` — both pass with 0 failures. Then `bun test` — full suite passes.</verify>
  <done>Both previously-failing tests pass. Full `bun test` exits 0.</done>
</task>

<task type="auto">
  <name>Task 2: Add test script to package.json</name>
  <files>package.json</files>
  <action>
  Add a `"scripts"` section to `package.json` with `"test": "bun test"`. The file currently has no scripts section at all. Add it after the `"bin"` field:

  ```json
  "scripts": {
    "test": "bun test"
  },
  ```

  Do NOT modify any other fields. Do NOT add devDependencies. bun:test is built into Bun — no package install needed.
  </action>
  <verify>`bun run test` exits 0 (verifies the script works). `grep '"test"' package.json` shows the entry.</verify>
  <done>`bun run test` passes all tests via the package.json script.</done>
</task>

</tasks>

<verification>
1. `bun test` — exits 0, zero failures
2. `bun run test` — same result (proves package.json script works)
3. No production code changes — only test files and package.json
</verification>

<success_criteria>
- Zero test failures across full suite
- `package.json` has `"test": "bun test"` in scripts
- Both `bun test` and `bun run test` exit 0
</success_criteria>

<output>
After completion, create `.planning/phases/10-fixtures-infrastructure-test-health/10-01-SUMMARY.md`
</output>
