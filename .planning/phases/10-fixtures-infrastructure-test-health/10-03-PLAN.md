---
phase: 10-fixtures-infrastructure-test-health
plan: 03
type: execute
wave: 2
depends_on:
  - "10-02"
files_modified:
  - test/fixtures/claude/commands/groom-docs.md
  - test/fixtures/claude/commands/obs-jot.md
  - test/fixtures/claude/agents/test-agent.md
  - test/fixtures/claude/agents/simple-agent.md
  - test/fixtures/claude/instructions/CLAUDE.md
  - test/fixtures/opencode/commands/groom-docs.md
  - test/fixtures/opencode/commands/obs-jot.md
  - test/fixtures/opencode/agents/test-agent.md
  - test/fixtures/opencode/agents/simple-agent.md
  - test/fixtures/opencode/instructions/AGENTS.md
  - test/fixtures/gemini/commands/groom-docs.toml
  - test/fixtures/gemini/commands/obs-jot.toml
  - test/fixtures/gemini/agents/test-agent.md
  - test/fixtures/gemini/agents/simple-agent.md
  - test/fixtures/gemini/instructions/AGENTS.md
  - test/fixtures/codex/commands/groom-docs.md
  - test/fixtures/codex/commands/obs-jot.md
  - test/fixtures/codex/agents/agent-test-agent.md
  - test/fixtures/codex/agents/agent-simple-agent.md
  - test/fixtures/codex/instructions/AGENTS.md
  - test/fixtures/claude/skills/obsidian/SKILL.md
  - test/fixtures/opencode/skills/obsidian/SKILL.md
  - test/fixtures/gemini/skills/obsidian/SKILL.md
  - test/fixtures/codex/skills/obsidian/SKILL.md
  - test/fixtures/claude/skills/web-design-guidelines/SKILL.md
  - test/fixtures/opencode/skills/web-design-guidelines/SKILL.md
  - test/fixtures/gemini/skills/web-design-guidelines/SKILL.md
  - test/fixtures/codex/skills/web-design-guidelines/SKILL.md
  - test/__tests__/fixtures-smoke.test.ts
autonomous: true
requirements:
  - FIX-03
  - FIX-07

must_haves:
  truths:
    - "Per-target fixture directories contain expected push outputs for all 4 CLI targets"
    - "Golden files match what the renderers actually produce"
    - "Smoke test validates the withBackup harness and fixture round-trip"
  artifacts:
    - path: "test/fixtures/claude/"
      provides: "Claude target golden outputs (commands, agents, skills, instructions)"
    - path: "test/fixtures/opencode/"
      provides: "OpenCode target golden outputs (commands, agents, skills, instructions)"
    - path: "test/fixtures/gemini/"
      provides: "Gemini target golden outputs (commands as TOML, agents, skills, instructions)"
    - path: "test/fixtures/codex/"
      provides: "Codex target golden outputs (flat markdown commands, agent- prefixed agents, skills, instructions)"
    - path: "test/__tests__/fixtures-smoke.test.ts"
      provides: "Smoke test proving fixtures + harness work"
  key_links:
    - from: "test/__tests__/fixtures-smoke.test.ts"
      to: "test/helpers/backup.ts"
      via: "import { withBackup }"
      pattern: "import.*withBackup.*backup"
    - from: "test/__tests__/fixtures-smoke.test.ts"
      to: "test/fixtures/"
      via: "reads canonical fixtures and compares against golden files"
      pattern: "fixtures/canonical|fixtures/claude|fixtures/opencode"
    - from: "test/fixtures/{target}/"
      to: "src/adapters/"
      via: "golden files match renderer output"
      pattern: "renderCommand|renderAgent|renderInstructions"
---

<objective>
Generate per-target golden fixture files by running the actual renderers against canonical fixtures, then write a smoke test validating the fixture infrastructure and backup harness.

Purpose: FIX-03 requires per-target expected output fixtures for all 4 CLI targets. The golden files are generated by actually rendering the canonical fixtures through the adapters — ensuring they match real renderer behavior. A smoke test validates the whole fixture + harness stack works.
Output: `test/fixtures/{claude,opencode,gemini,codex}/` with golden output files, `test/__tests__/fixtures-smoke.test.ts`
</objective>

<execution_context>
@/Users/m332023/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/m332023/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-fixtures-infrastructure-test-health/10-02-SUMMARY.md
@src/adapters/claude-code.ts
@src/adapters/opencode.ts
@src/adapters/gemini.ts
@src/adapters/codex.ts
@src/adapters/base.ts
@src/adapters/path-resolver.ts
@src/types.ts
@test/fixtures/canonical/
@test/helpers/backup.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Generate per-target golden fixture files via renderers</name>
  <files>
    test/fixtures/claude/commands/*.md,
    test/fixtures/claude/agents/*.md,
    test/fixtures/claude/skills/*/SKILL.md,
    test/fixtures/claude/instructions/CLAUDE.md,
    test/fixtures/opencode/commands/*.md,
    test/fixtures/opencode/agents/*.md,
    test/fixtures/opencode/skills/*/SKILL.md,
    test/fixtures/opencode/instructions/AGENTS.md,
    test/fixtures/gemini/commands/*.toml,
    test/fixtures/gemini/agents/*.md,
    test/fixtures/gemini/skills/*/SKILL.md,
    test/fixtures/gemini/instructions/AGENTS.md,
    test/fixtures/codex/commands/*.md,
    test/fixtures/codex/agents/agent-*.md,
    test/fixtures/codex/skills/*/SKILL.md,
    test/fixtures/codex/instructions/AGENTS.md
  </files>
  <action>
  Write a one-shot generation script (`test/generate-golden.ts`) that:
  1. Reads each canonical fixture from `test/fixtures/canonical/`
  2. Renders through all 4 adapters (ClaudeCodeAdapter, OpenCodeAdapter, GeminiAdapter, CodexAdapter)
  3. Writes rendered output to `test/fixtures/{target}/` with correct filenames per target

  Then run the script once to produce the golden files. Commit both the script and the generated golden files.

  **Per-target rendering rules** (from existing adapter code):

  **Commands:**
  - Claude: verbatim passthrough (same as canonical)
  - OpenCode: frontmatter stripped to `description` key only, body preserved
  - Gemini: TOML format with `description = "..."` and triple-quoted `prompt = '''\n...\n'''`, extension `.toml`
  - Codex: flat markdown `# /{name}\n\n{description}\n\n{body}` (no frontmatter)

  **Agents:**
  - Claude: verbatim passthrough
  - OpenCode: frontmatter has `description` + `mode: subagent` (name and allowed-tools stripped from frontmatter), body preserved
  - Gemini: frontmatter has `description` + `allowed-tools` (if present) + `kind: local`, body preserved
  - Codex: flat markdown `# Agent: {name}\n\n**Role**: {description}\n\n**Allowed Tools**: {tools}\n\n{body}`. Uses `agent-{name}.md` filename.

  **Skills:**
  - All 4 targets: verbatim passthrough (skills render as identity — same content as canonical)
  - Per-target filenames preserved (SKILL.md in skill subdirectory)

  **Instructions:**
  - Claude: verbatim passthrough, filename is `CLAUDE.md`
  - OpenCode: verbatim passthrough, filename is `AGENTS.md`
  - Gemini: verbatim passthrough, filename is `AGENTS.md`
  - Codex: verbatim passthrough, filename is `AGENTS.md`

  **MCP and Settings golden files are EXCLUDED from this plan.** MCP rendering merges into existing JSON/TOML config files (not standalone files) — golden file comparison doesn't apply cleanly. Settings are target-specific JSON structures, not rendered from canonical. These will be tested as inline assertions in Phase 11 E2E tests instead.

  **Directory structure:**
  ```
  test/fixtures/
    claude/
      commands/groom-docs.md, obs-jot.md
      agents/test-agent.md, simple-agent.md
      skills/obsidian/SKILL.md, web-design-guidelines/SKILL.md
      instructions/CLAUDE.md
    opencode/
      commands/groom-docs.md, obs-jot.md
      agents/test-agent.md, simple-agent.md
      skills/obsidian/SKILL.md, web-design-guidelines/SKILL.md
      instructions/AGENTS.md
    gemini/
      commands/groom-docs.toml, obs-jot.toml
      agents/test-agent.md, simple-agent.md
      skills/obsidian/SKILL.md, web-design-guidelines/SKILL.md
      instructions/AGENTS.md
    codex/
      commands/groom-docs.md, obs-jot.md
      agents/agent-test-agent.md, agent-simple-agent.md
      skills/obsidian/SKILL.md, web-design-guidelines/SKILL.md
      instructions/AGENTS.md
  ```

  **Generation script** (`test/generate-golden.ts`):
  - Import adapters from `src/adapters/`
  - Import `parseFrontmatter` from `src/formats/markdown`
  - Read each canonical fixture
  - Parse into CanonicalItem format (extract name from filename, parse frontmatter for description/allowed-tools)
  - Call adapter's `renderCommand`/`renderAgent`/`renderInstructions` (these return `RenderedFile` with `.content`)
  - For skills: copy verbatim (identity rendering)
  - Write to per-target directories
  - Print summary of generated files

  Script is run via `bun test/generate-golden.ts`. Keep it simple — no CLI flags needed. This script is a dev tool for regenerating golden files when renderers change.
  </action>
  <verify>`ls -R test/fixtures/claude/ test/fixtures/opencode/ test/fixtures/gemini/ test/fixtures/codex/` — all 4 targets have commands/, agents/, skills/, instructions/ with expected files. Gemini commands have .toml extension. Codex agents have `agent-` prefix. Claude instructions is `CLAUDE.md`.</verify>
  <done>Per-target golden fixture files exist for all 4 targets covering commands, agents, skills, and instructions. Generation script committed for future regeneration.</done>
</task>

<task type="auto">
  <name>Task 2: Write smoke test for fixture infrastructure and backup harness</name>
  <files>test/__tests__/fixtures-smoke.test.ts</files>
  <action>
  Create `test/__tests__/fixtures-smoke.test.ts` — a smoke test that validates:

  1. **Fixture completeness**: All expected fixture files exist
  2. **Fixture content**: Canonical fixtures parse correctly (frontmatter extracts, JSON parses)
  3. **Golden file accuracy**: Re-render canonical fixtures through adapters, compare against committed golden files (byte-for-byte match)
  4. **withBackup harness**: Verify backup/restore works correctly

  **Test structure:**
  ```typescript
  import { describe, test, expect } from 'bun:test';
  import { readFileSync, existsSync, mkdtempSync, writeFileSync, rmSync } from 'node:fs';
  import { join } from 'node:path';
  import { tmpdir } from 'node:os';
  import { withBackup } from '../helpers/backup';
  // Import adapters for golden file comparison
  import { ClaudeCodeAdapter } from '../../src/adapters/claude-code';
  import { OpenCodeAdapter } from '../../src/adapters/opencode';
  import { GeminiAdapter } from '../../src/adapters/gemini';
  import { CodexAdapter } from '../../src/adapters/codex';
  import { parseFrontmatter } from '../../src/formats/markdown';

  const FIXTURE_ROOT = join(import.meta.dir, '..', 'fixtures');

  describe('Fixture completeness', () => {
    // Test that all 6 canonical type directories exist
    // Test that each has expected file count
    // Test that all 4 target directories exist
  });

  describe('Golden file accuracy', () => {
    // For each canonical command/agent/skill/instruction:
    //   render through each adapter
    //   compare result against committed golden file
    //   expect exact match
    // This catches renderer changes that invalidate golden files
  });

  describe('withBackup harness', () => {
    // Create temp dir with files
    // Use withBackup to wrap a function that modifies the files
    // After withBackup completes, verify files restored to original state
    // Also test: withBackup restores when fn throws (try/finally)
  });
  ```

  **Golden file accuracy tests** — iterate programmatically:
  - Read canonical command → parseFrontmatter → create CanonicalItem → renderCommand per adapter → compare to golden file
  - Same pattern for agents and instructions
  - Skills: compare canonical to golden (should be identical)
  - If any golden file doesn't match, test fails with diff showing what changed — signals regeneration needed

  **withBackup harness tests:**
  - Test 1: Normal operation — create temp dir with `hello.txt`, withBackup wraps deletion of that file, verify file exists after withBackup returns
  - Test 2: Error recovery — withBackup wraps a function that throws, verify dir restored AND error re-thrown
  - Test 3: Non-existent dir — withBackup with a dir that doesn't exist, fn creates it, verify dir removed after

  Keep total test count reasonable (~15-20 tests). These are infrastructure smoke tests, not exhaustive E2E (that's Phase 11-12).
  </action>
  <verify>`bun test test/__tests__/fixtures-smoke.test.ts` passes all tests. `bun test` full suite still passes (no regressions).</verify>
  <done>Smoke test validates fixture completeness, golden file accuracy, and withBackup harness reliability. All tests pass.</done>
</task>

</tasks>

<verification>
1. `ls -R test/fixtures/{claude,opencode,gemini,codex}/` — all 4 targets populated
2. `bun test test/__tests__/fixtures-smoke.test.ts` — all tests pass
3. `bun test` — full suite green, zero regressions
4. Golden files match current renderer output (smoke test proves this)
5. withBackup correctly restores directories on success and failure
</verification>

<success_criteria>
- All 4 per-target fixture directories committed with golden output files
- Golden files accurately represent current renderer behavior
- Smoke test validates fixture completeness, golden accuracy, and harness reliability
- Generation script exists for future golden file regeneration
- `bun test` passes with zero failures
</success_criteria>

<output>
After completion, create `.planning/phases/10-fixtures-infrastructure-test-health/10-03-SUMMARY.md`
</output>
