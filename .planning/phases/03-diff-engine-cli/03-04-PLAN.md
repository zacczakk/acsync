---
phase: 03-diff-engine-cli
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/adapters/path-resolver.ts
  - src/adapters/claude-code.ts
  - src/adapters/__tests__/claude-code.test.ts
  - src/cli/__tests__/orchestrator.test.ts
  - src/types.ts
  - src/cli/push.ts
  - src/cli/orchestrator.ts
autonomous: true
gap_closure: true
requirements: [CLI-05, CLI-07, DIFF-03]

must_haves:
  truths:
    - "Commands render to ~/.claude/commands/{name}.md (no zz/ subdir, no prefix strip)"
    - "push --delete flag gates stale file deletion; omitting it skips deletes"
    - "check always surfaces stale items in output regardless of --delete flag"
  artifacts:
    - path: "src/adapters/path-resolver.ts"
      provides: "Claude rawCommandsDir returns ~/.claude/commands/ (no zz/)"
      contains: "~/.claude/commands/"
    - path: "src/adapters/claude-code.ts"
      provides: "No commandNameFromFile override"
    - path: "src/types.ts"
      provides: "SyncOptions.deleteStale field"
      contains: "deleteStale"
    - path: "src/cli/push.ts"
      provides: "--delete flag wired into SyncOptions"
    - path: "src/cli/orchestrator.ts"
      provides: "deleteOps gated on options.deleteStale"
  key_links:
    - from: "src/cli/push.ts"
      to: "src/cli/orchestrator.ts"
      via: "SyncOptions.deleteStale"
      pattern: "deleteStale"
    - from: "src/cli/orchestrator.ts deleteOps loop"
      to: "options.deleteStale guard"
      via: "if (options.deleteStale)"
      pattern: "options\\.deleteStale"
---

<objective>
Fix two UAT failures from test 5:

1. **Claude zz/ subdir** — Commands pushed to `~/.claude/commands/zz/{name}.md` instead of `~/.claude/commands/{name}.md`. Remove zz/ nesting and zz- prefix logic from path-resolver + ClaudeCodeAdapter. Update tests.

2. **push --delete flag** — Stale file deletion runs unconditionally. Add `--delete` flag to push CLI; gate delete loop in orchestrator behind `options.deleteStale`. Check already surfaces stale ops (formatter shows them) — no formatter changes needed.

Purpose: After push, subsequent check shows 0 drift for commands. Stale files only deleted when user opts in with --delete.
Output: Corrected path-resolver, stripped ClaudeCodeAdapter override, SyncOptions.deleteStale field, push --delete flag, guarded delete loop, updated tests.
</objective>

<execution_context>
@/Users/m332023/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/m332023/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-diff-engine-cli/03-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix Claude command path — remove zz/ subdir and prefix logic</name>
  <files>
    src/adapters/path-resolver.ts
    src/adapters/claude-code.ts
    src/adapters/__tests__/claude-code.test.ts
    src/cli/__tests__/orchestrator.test.ts
  </files>
  <action>
**path-resolver.ts** — `rawCommandsDir()` claude-code case:
- Change `'~/.claude/commands/zz/'` → `'~/.claude/commands/'`

**path-resolver.ts** — `commandFileName()` claude-code case:
- Remove the entire claude-code case (strip-zz- prefix logic). Claude command files are now just `${name}.md` — falls through to default case.
- After removal the switch looks like: `case 'gemini': return \`${name}.toml\`; default: return \`${name}.md\`;`

**claude-code.ts** — remove `commandNameFromFile()` override entirely (lines 20-24). The base class default handles `.md` → name. No prefix logic.

**claude-code.test.ts** — update 3 failing assertions:
- `'strips zz- prefix and nests under zz/ directory'` test: change expected path to `path.join(HOME, '.claude/commands/plan.md')` and rename test desc to `'nests directly under commands/ directory'`
- `'handles item without zz- prefix'` test: change expected path to `path.join(HOME, '.claude/commands/mycommand.md')`
- Remove the comment in renderCommand that mentions zz/ (line 28-29 in claude-code.ts)

**orchestrator.test.ts** — line 176-181 afterEach cleanup:
- Change `join(homedir(), '.claude', 'commands', 'zz')` → `join(homedir(), '.claude', 'commands')`
- File names are now `test-${salt}-alpha.md` and `test-${salt}-beta.md` (no prefix strip — canonical names used directly)

Run `bun test src/adapters/__tests__/claude-code.test.ts src/cli/__tests__/orchestrator.test.ts` to verify green.
  </action>
  <verify>bun test src/adapters/__tests__/claude-code.test.ts src/cli/__tests__/orchestrator.test.ts</verify>
  <done>All adapter and orchestrator tests pass. Claude command path resolves to ~/.claude/commands/{name}.md.</done>
</task>

<task type="auto">
  <name>Task 2: Add --delete flag to push; gate delete loop in orchestrator</name>
  <files>
    src/types.ts
    src/cli/push.ts
    src/cli/orchestrator.ts
  </files>
  <action>
**types.ts** — in `SyncOptions` interface (lines 26-33), add field:
```typescript
deleteStale?: boolean;    // --delete (remove stale target files)
```

**push.ts** — in the `pushCommand` option chain, add after `--force`:
```typescript
.option('--delete', 'Delete stale target files not in canonical source (default: skip)')
```
In the action options type, add `delete?: boolean;`.
In `syncOpts` object construction, add `deleteStale: options.delete`.
Also pass `deleteStale: options.delete` when calling the confirmation-path `runPush({ ...syncOpts, force: true })`.

**orchestrator.ts** — in `runPush`, the delete loop (lines 667-683) currently runs unconditionally. Wrap it:
```typescript
// Delete stale items (only when --delete flag is set)
if (options.deleteStale) {
  for (const op of deleteOps) {
    // ... existing loop body unchanged
  }
}
```

Note: `runCheck` already appends stale ops to `diff.operations` (lines 508-516) and the formatter already renders delete ops as stale in check output — no changes needed there.

Run `bun test` to confirm full suite green.
  </action>
  <verify>bun test && bun src/cli/index.ts check --pretty 2>&1 | head -40</verify>
  <done>Full test suite passes. `check` output shows stale items. `push` without --delete skips deletes; `push --delete` would execute them.</done>
</task>

</tasks>

<verification>
1. `bun test` — full suite green, no regressions
2. `bun src/cli/index.ts push --force --target claude-code --type command --dry-run` — shows obs-* commands going to ~/.claude/commands/ (no zz/)
3. `bun src/cli/index.ts check --pretty` — stale items show in output
4. `bun src/cli/index.ts push --force` — runs without deleting stale; `push --delete --force` — executes deletes
</verification>

<success_criteria>
- Claude commands write to ~/.claude/commands/{name}.md, never ~/.claude/commands/zz/
- ClaudeCodeAdapter has no commandNameFromFile override
- path-resolver claude-code rawCommandsDir = ~/.claude/commands/ (no trailing zz/)
- SyncOptions has deleteStale?: boolean
- push CLI has --delete flag
- orchestrator delete loop is guarded by `if (options.deleteStale)`
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-diff-engine-cli/03-04-SUMMARY.md`
</output>
