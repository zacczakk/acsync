---
phase: 03-diff-engine-cli
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/core/manifest.ts
  - src/core/diff.ts
  - src/core/rollback.ts
  - src/core/formatter.ts
  - src/core/__tests__/manifest.test.ts
  - src/core/__tests__/diff.test.ts
  - src/core/__tests__/rollback.test.ts
  - src/core/__tests__/formatter.test.ts
  - src/types.ts
  - src/errors.ts
autonomous: true
requirements:
  - DIFF-02
  - DIFF-03
  - DIFF-04
  - DIFF-05
  - FILE-04

must_haves:
  truths:
    - "Manifest can be loaded from disk, returns empty manifest if missing"
    - "Manifest saves atomically via existing atomicWrite"
    - "3-way hash comparison (source/target/manifest) produces correct create/update/skip operations"
    - "Diff produces structured JSON output suitable for agent consumption"
    - "Diff produces colored human-readable text output for --pretty mode"
    - "Rollback tracks every file written during a push and restores all on failure"
    - "Rollback deletes newly-created files (ones that didn't exist before push)"
  artifacts:
    - path: "src/core/manifest.ts"
      provides: "Manifest CRUD — load, save, create empty, update after sync"
      exports: ["loadManifest", "saveManifest", "createEmptyManifest", "updateManifestItem"]
    - path: "src/core/diff.ts"
      provides: "3-way diff engine — compare hashes, calculate diff per target"
      exports: ["compareHashes", "calculateDiff"]
    - path: "src/core/rollback.ts"
      provides: "Rollback mechanism — create backup, restore all, cleanup"
      exports: ["createBackup", "restoreBackup", "cleanupBackup"]
    - path: "src/core/formatter.ts"
      provides: "Output formatters — JSON and colored human-readable"
      exports: ["formatDiffJson", "formatDiffPretty", "formatPushResult"]
    - path: "src/types.ts"
      provides: "Manifest, ManifestItem, TargetStatus, Operation, DiffResult types"
      contains: "interface Manifest"
  key_links:
    - from: "src/core/diff.ts"
      to: "src/core/manifest.ts"
      via: "reads manifest hashes for 3-way comparison"
      pattern: "manifest\\.items\\["
    - from: "src/core/rollback.ts"
      to: "src/infra/atomic-write.ts"
      via: "uses atomicWrite for crash-safe restore"
      pattern: "atomicWrite"
    - from: "src/core/formatter.ts"
      to: "src/core/diff.ts"
      via: "formats DiffResult into output strings"
      pattern: "DiffResult"
---

<objective>
Manifest manager, 3-way diff engine, rollback mechanism, and output formatters — the core data pipeline that compares canonical configs against rendered targets and tracks sync state.

Purpose: Provide the diff/sync engine that Plan 02's CLI shell will orchestrate. Ported from vsync's battle-tested patterns, simplified for our fixed 4-target architecture.
Output: 4 core modules with tests, extended types
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-diff-engine-cli/03-CONTEXT.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
@.planning/phases/02-renderers-secrets/02-01-SUMMARY.md

Key vsync files to port from (read these during execution):
- ~/Repos/oss/vsync/cli/src/types/manifest.ts — Manifest, ManifestItem, TargetStatus types
- ~/Repos/oss/vsync/cli/src/types/plan.ts — Operation, OperationType, DiffResult types
- ~/Repos/oss/vsync/cli/src/core/diff.ts — compareHashes, calculateDiff
- ~/Repos/oss/vsync/cli/src/core/manifest-manager.ts — load/save/create/update manifest
- ~/Repos/oss/vsync/cli/src/core/rollback.ts — createBackup/restoreBackup/cleanupBackup
- ~/Repos/oss/vsync/cli/src/core/planner.ts — formatPlan for display formatting

Existing codebase context:
- src/types.ts has TargetName, CanonicalItem, MCPServer, RenderedFile, AdapterCapabilities
- src/errors.ts has ErrorSeverity, SyncError hierarchy, shouldRollback helper
- src/infra/atomic-write.ts has atomicWrite (backup-first + temp/fsync/rename)
- src/infra/hash.ts has hashFile, hashDirectory
- src/infra/backup.ts has backupFile, createBackupDir (Phase 1 approach — rollback REPLACES this for push operations)
- src/formats/json.ts has readJson, writeJson
</context>

<tasks>

<task type="auto">
  <name>Task 1: Types, manifest manager, and 3-way diff engine</name>
  <files>src/types.ts, src/errors.ts, src/core/manifest.ts, src/core/diff.ts, src/core/__tests__/manifest.test.ts, src/core/__tests__/diff.test.ts</files>
  <action>
**Types (src/types.ts)** — Add these types, ported from vsync with simplifications:

```typescript
// Config item types synced by acsync
type ItemType = 'command' | 'agent' | 'mcp' | 'instruction' | 'skill';

// Operation types (no 'delete' — we never delete non-canonical items per EXCL-02)
type OperationType = 'create' | 'update' | 'skip';

interface TargetStatus {
  hash: string;
  lastSynced: string;  // ISO 8601
}

interface ManifestItem {
  type: ItemType;
  name: string;
  sourceHash: string;
  lastSynced: string;
  targets: Partial<Record<TargetName, TargetStatus>>;
}

interface Manifest {
  version: '1.0.0';
  lastSynced: string;
  items: Record<string, ManifestItem>;  // key = "type/name"
}

interface Operation {
  type: OperationType;
  itemType: ItemType;
  name: string;
  target: TargetName;
  reason: string;
  oldHash?: string;
  newHash?: string;
  sourcePath?: string;   // canonical source file
  targetPath?: string;   // rendered target file
}

interface DiffResult {
  target: TargetName;
  operations: Operation[];  // all ops for this target (create + update + skip)
  summary: { create: number; update: number; skip: number };
}
```

No 'delete' operation type — per EXCL-02, we skip non-canonical items, never delete them. This is simpler than vsync which has prune mode.

**Errors (src/errors.ts)** — Add:
- `DiffError extends SyncError` (RECOVERABLE severity)
- `ManifestError extends SyncError` (RECOVERABLE severity)
- `RollbackError extends SyncError` (FATAL severity)

Follow existing pattern: constructor takes (message, ErrorContext).

**Manifest Manager (src/core/manifest.ts):**

Port from vsync's `core/manifest-manager.ts`. Key differences:
- Store manifest at `.acsync/manifest.json` in project root (not ~/.vsync/cache/<hash>/)
- Use our existing `readJson`/`writeJson` from `src/formats/json.ts` for parsing
- Use our existing `atomicWrite` from `src/infra/atomic-write.ts` for saves
- Use `TargetName` (not vsync's `ToolName`)

Functions to implement:
1. `getManifestPath(projectDir?: string): string` — returns `join(projectDir ?? cwd(), '.acsync', 'manifest.json')`
2. `createEmptyManifest(): Manifest` — returns `{ version: '1.0.0', lastSynced: now, items: {} }`
3. `loadManifest(projectDir?: string): Promise<Manifest>` — read from disk, return empty if missing/corrupt, wrap errors in ManifestError
4. `saveManifest(manifest: Manifest, projectDir?: string): Promise<void>` — update lastSynced, atomicWrite with `mkdir -p` for .acsync dir
5. `updateManifestItem(manifest: Manifest, type: ItemType, name: string, sourceHash: string, target: TargetName, targetHash: string): void` — create/update item + target entry in-place
6. `getManifestHash(manifest: Manifest, type: ItemType, name: string, target: TargetName): string | null` — return target hash or null

**3-Way Diff Engine (src/core/diff.ts):**

Port from vsync's `core/diff.ts`. Key simplifications:
- No SyncMode/prune — always safe mode (skip items not in source)
- No targetCapabilities filtering — our renderers already handle `disabledFor`
- No separate source/target item lists — we work with hashes directly

Functions:
1. `compareHashes(sourceHash: string | null, targetHash: string | null, manifestHash: string | null): { operation: OperationType; reason: string }` — 3-way comparison logic:
   - sourceHash null → skip (item not in source, safe mode)
   - targetHash null → create (item not in target)
   - all three match → skip (up to date)
   - source === target → skip (up to date, manifest stale)
   - source !== target → update (content changed)

2. `calculateDiff(sourceItems: Array<{type: ItemType; name: string; hash: string; sourcePath?: string; targetPath?: string}>, targetHashes: Map<string, string>, manifest: Manifest, target: TargetName): DiffResult` — iterate source items, look up target hash and manifest hash, call compareHashes, build operations array and summary.

**Tests:**
- manifest.test.ts: createEmptyManifest, loadManifest (missing file, corrupt file, valid file), saveManifest (creates .acsync dir, atomic), updateManifestItem, getManifestHash. Use real filesystem (mkdtempSync pattern from Phase 1).
- diff.test.ts: compareHashes (all 5 cases), calculateDiff with various scenarios (all new, all up-to-date, mixed create/update/skip).
  </action>
  <verify>Run `bun test src/core/__tests__/manifest.test.ts src/core/__tests__/diff.test.ts` — all tests pass. Verify manifest.json written to temp dir is valid JSON with correct structure.</verify>
  <done>Manifest loads/saves/updates correctly. 3-way diff produces correct create/update/skip operations for all hash comparison cases. No delete operations ever produced.</done>
</task>

<task type="auto">
  <name>Task 2: Rollback mechanism and output formatters</name>
  <files>src/core/rollback.ts, src/core/formatter.ts, src/core/__tests__/rollback.test.ts, src/core/__tests__/formatter.test.ts</files>
  <action>
**Rollback (src/core/rollback.ts):**

Port from vsync's `core/rollback.ts`. This REPLACES Phase 1's backup-only approach (`src/infra/backup.ts`) for push operations. Phase 1's backup module stays for other uses, but push uses this rollback module.

Key type:
```typescript
interface BackupInfo {
  originalPath: string;
  backupPath: string;    // empty if file didn't exist
  existed: boolean;
  timestamp: string;
}
```

Functions:
1. `createBackup(filePath: string): Promise<BackupInfo>` — check if file exists (Bun.file().exists()), if yes copy to `.acsync-backup-{timestamp}-{basename}` in same directory, return BackupInfo. If file doesn't exist, return `{ existed: false, backupPath: '' }`. Wrap errors in RollbackError.

2. `restoreBackup(backup: BackupInfo): Promise<void>` — if !existed, delete the file (it was newly created). If existed, read backup content and restore via atomicWrite. Swallow errors (best-effort during failure recovery).

3. `cleanupBackup(backup: BackupInfo): Promise<void>` — delete backup file after successful push. Swallow errors.

4. `restoreAll(backups: BackupInfo[]): Promise<{restored: number; failed: number}>` — iterate all backups in reverse order, call restoreBackup on each, count successes/failures. Log each restoration as it happens (console.error for visibility). This is the entry point called on push failure.

5. `cleanupAll(backups: BackupInfo[]): Promise<void>` — cleanup all backups after success.

Use `node:fs/promises` copyFile for backup (same as Phase 1 backup.ts). Use `Bun.file().exists()` for existence check. Use our `atomicWrite` for restore (crash safety).

Per CONTEXT.md decision: "Rollback on failure is verbose: show each file being restored as it happens, then the error"

**Formatters (src/core/formatter.ts):**

Per CONTEXT.md: JSON is default output, `--pretty` for human-readable.

1. `formatDiffJson(results: DiffResult[]): string` — JSON.stringify the diff results. Structure:
```json
{
  "targets": {
    "claude-code": { "create": 3, "update": 1, "skip": 5, "operations": [...] },
    "opencode": { ... }
  },
  "summary": { "totalCreate": 5, "totalUpdate": 2, "totalSkip": 12 }
}
```

2. `formatDiffPretty(results: DiffResult[]): string` — colored human output modeled after `gh pr status` richness level (per CONTEXT.md). Use `picocolors` (install it — lighter than chalk, no dependencies). Structure:
```
acsync check

  claude-code
    + [command] gsd-plan-phase     (new)
    ~ [agent]   gsd-planner        (modified)
    ✓ [mcp]     context7           (up to date)

  opencode
    + [command] gsd-plan-phase     (new)
    ...

  Summary: 5 to create, 2 to update, 12 up to date
```

Use picocolors: green for create (+), yellow for update (~), dim for skip (✓).

3. `formatPushResult(results: Array<{target: TargetName; operations: Operation[]; success: boolean; error?: string}>, pretty: boolean): string` — format push results in JSON or pretty mode.

4. `formatCheckResult(results: DiffResult[], pretty: boolean): string` — convenience wrapper: returns formatDiffJson or formatDiffPretty based on `pretty` flag. Also returns `hasDrift: boolean` for exit code calculation.

Install `picocolors` via `bun add picocolors`.

**Tests:**
- rollback.test.ts: createBackup (existing file, non-existing file), restoreBackup (restore existing, delete new), cleanupBackup, restoreAll (mix of existing/new). Real filesystem.
- formatter.test.ts: formatDiffJson (valid JSON structure, correct counts), formatDiffPretty (contains target names, operation symbols, summary line). Test formatCheckResult hasDrift logic.
  </action>
  <verify>Run `bun test src/core/__tests__/rollback.test.ts src/core/__tests__/formatter.test.ts` — all tests pass. Run `bun test` for full suite — no regressions (expect 219+ existing tests still passing).</verify>
  <done>Rollback tracks and restores files on push failure. Formatters produce valid JSON for agents and colored text for humans. Full test suite green.</done>
</task>

</tasks>

<verification>
- `bun test` — full suite passes (219 existing + new tests)
- Manifest round-trips through load/save correctly
- 3-way diff handles all hash comparison cases (create, update, skip — no deletes)
- Rollback restores files that existed pre-push AND deletes newly-created files
- JSON output is parseable, pretty output has ANSI color codes
</verification>

<success_criteria>
- Manifest CRUD works with atomic saves
- 3-way diff correctly classifies all operations
- Rollback can fully reverse a failed push
- Both JSON and pretty formatters produce correct output
- All tests pass, no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/03-diff-engine-cli/03-01-SUMMARY.md`
</output>
