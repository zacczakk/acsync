---
phase: 03-diff-engine-cli
plan: 03
type: execute
wave: 3
depends_on:
  - 03-02
files_modified:
  - configs/common/mcp/context7.json
  - configs/common/mcp/tavily.json
  - configs/common/mcp/sequential-thinking.json
  - AGENTS.md
  - configs/claude/addendum.md
  - configs/opencode/addendum.md
autonomous: false

requirements:
  - DIFF-02
  - DIFF-03

must_haves:
  truths:
    - "acsync check detects drift for the trimmed 3-server canonical MCP set"
    - "acsync push --force writes MCP configs correctly to all 4 targets"
    - "Only 3 canonical MCP files remain: context7, tavily, sequential-thinking"
    - "MCPorter config exists at ~/.mcporter/mcporter.json with 4 servers"
    - "AGENTS.md documents mcporter usage"
  artifacts:
    - path: "configs/common/mcp/context7.json"
      provides: "Canonical MCP: context7 (HTTP, all CLIs)"
    - path: "configs/common/mcp/tavily.json"
      provides: "Canonical MCP: tavily (stdio, Claude only)"
    - path: "configs/common/mcp/sequential-thinking.json"
      provides: "Canonical MCP: sequential-thinking (disabled)"
  key_links:
    - from: "src/cli/orchestrator.ts"
      to: "configs/common/mcp/"
      via: "reads canonical MCP configs for diff/push"
      pattern: "configs/common/mcp"
---

<objective>
MCPorter hybrid setup + end-to-end pipeline exercise: trim canonical MCP to 3 servers, set up MCPorter for 4 non-native servers, update documentation, then run the full acsync check → push pipeline to verify everything works together.

Purpose: Complete the MCPorter migration (operational config task) while exercising the entire acsync pipeline end-to-end as an integration test.
Output: Working MCPorter hybrid setup, updated docs, verified E2E pipeline
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-diff-engine-cli/03-CONTEXT.md
@.planning/phases/03-diff-engine-cli/03-01-SUMMARY.md
@.planning/phases/03-diff-engine-cli/03-02-SUMMARY.md
@MCPORTER_ANALYSIS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Trim canonical MCP to 3 servers + update documentation</name>
  <files>configs/common/mcp/context7.json, configs/common/mcp/tavily.json, configs/common/mcp/sequential-thinking.json, AGENTS.md, configs/claude/addendum.md, configs/opencode/addendum.md</files>
  <action>
Follow MCPORTER_ANALYSIS.md Steps 4-7:

**Step 1: Remove non-native MCP configs from canonical:**
Use `trash` (not rm) to remove these from `configs/common/mcp/`:
- chrome-devtools-mcp.json (or whatever the actual filename is)
- foundry-mcp.json
- liquid-carbon.json
- shadcn.json

First `ls configs/common/mcp/` to see actual filenames. Only trash files for servers moving to MCPorter.

**Step 2: Edit sequential-thinking.json** — ensure `"enabled": false` is set (if not already).

**Step 3: Edit tavily.json** — add `"disabled_for": ["opencode", "gemini", "codex"]` so only Claude gets it natively. Other CLIs use Tavily's search tool via WebFetch or the Tavily SDK directly.

**Step 4: Update AGENTS.md** — Add mcporter to `## Tools` section:
```markdown
### mcporter
- MCP launcher for non-native servers. Keeps chrome-devtools warm via daemon.
- Usage: `mcporter call <server>.<tool> <args>` or `mcporter list <server>`
- Servers: chrome-devtools (daemon), foundry-mcp, liquid-carbon, shadcn.
- Config: `~/.mcporter/mcporter.json`
- Daemon: auto-starts on first keep-alive call; `mcporter daemon stop` to tear down.
```

**Step 5: Update CLI addendums:**
- `configs/opencode/addendum.md` — update web access section to mention Tavily search tool via WebFetch (no native Tavily MCP)
- `configs/claude/addendum.md` — add MCPorter note for non-native servers

**Note:** `~/.mcporter/mcporter.json` is NOT managed by acsync (per CONTEXT.md deferred decision). It's a one-time manual setup. The user will create it following MCPORTER_ANALYSIS.md Step 2.
  </action>
  <verify>
- `ls configs/common/mcp/` shows exactly 3 files: context7.json, tavily.json, sequential-thinking.json
- `grep mcporter AGENTS.md` finds the new tools section
- `grep disabled_for configs/common/mcp/tavily.json` shows opencode, gemini, codex
  </verify>
  <done>Canonical MCP trimmed to 3 servers. Documentation updated with MCPorter references. Non-native servers trashed (recoverable).</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: E2E verification — run acsync check and push</name>
  <what-built>
Complete acsync CLI pipeline: diff engine, manifest, rollback, CLI shell with check/push subcommands, and MCPorter hybrid MCP setup.
  </what-built>
  <how-to-verify>
1. Run `bun src/cli/index.ts check --pretty` — should show drift for all 4 targets (MCP configs changed due to server trimming)
2. Run `bun src/cli/index.ts check` — should output JSON with drift details
3. Verify exit code: `bun src/cli/index.ts check; echo $?` — should be 2 (drift detected)
4. Run `bun src/cli/index.ts push --dry-run --pretty` — should show execution plan
5. Run `bun src/cli/index.ts push --force --pretty` — should write configs to all targets
6. Run `bun src/cli/index.ts check; echo $?` — should now be 0 (no drift after push)
7. Verify target configs:
   - Claude: `cat ~/.claude/settings.json | jq .mcpServers` — should have context7 + tavily + sequential-thinking(disabled)
   - OpenCode: `cat ~/.config/opencode/settings.json` — should have context7 + sequential-thinking(disabled) only (tavily disabled_for opencode)
    - Verify no chrome-devtools, foundry, liquid-carbon, shadcn in any native MCP config
8. Run `bun test` — full test suite still passes
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
- Canonical MCP: exactly 3 files in configs/common/mcp/
- acsync check: detects drift, exits 2
- acsync push: writes configs, exits 0
- acsync check after push: no drift, exits 0
- MCPorter not managed by acsync (separate config)
- Full test suite passes
- AGENTS.md has mcporter documentation
</verification>

<success_criteria>
- 3 canonical MCP servers rendered to targets correctly
- MCPorter hybrid documented in AGENTS.md
- E2E pipeline works: check → push → verify
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-diff-engine-cli/03-03-SUMMARY.md`
</output>
