---
phase: 07-unify-instructions
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/adapters/__tests__/instructions.test.ts
  - src/cli/__tests__/render.test.ts
  - src/cli/__tests__/orchestrator.test.ts
  - src/cli/__tests__/check.test.ts
  - configs/instructions/claude.md
  - configs/instructions/opencode.md
  - configs/instructions/gemini.md
  - configs/instructions/codex.md
  - AGENTS.md
autonomous: true
requirements: [INST-01, INST-02, INST-03, INST-04]

must_haves:
  truths:
    - "All tests pass with bun test (0 failures)"
    - "No per-CLI addendum files exist in configs/instructions/ (only AGENTS.md)"
    - "No AGENTS.md at repo root"
    - "acsync check --type instructions shows expected drift for new filenames"
  artifacts:
    - path: "src/adapters/__tests__/instructions.test.ts"
      provides: "Tests for single-param renderInstructions"
    - path: "src/cli/__tests__/render.test.ts"
      provides: "Tests for single-file readCanonicalInstructions"
    - path: "src/cli/__tests__/orchestrator.test.ts"
      provides: "Integration tests with unified instructions setup"
  key_links:
    - from: "src/adapters/__tests__/instructions.test.ts"
      to: "src/adapters/base.ts"
      via: "adapter.renderInstructions(content)"
      pattern: "renderInstructions\\("
    - from: "src/cli/__tests__/orchestrator.test.ts"
      to: "src/cli/canonical.ts"
      via: "setupProject creates configs/instructions/AGENTS.md"
      pattern: "AGENTS\\.md"
---

<objective>
Update all tests for the new single-param instruction signatures, then delete addendum files and repo-root AGENTS.md. Verify full test suite passes and acsync check runs clean.

Purpose: Complete the unification by cleaning up old files and ensuring tests reflect the new reality.
Output: All tests passing, no stale files, clean acsync state.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-unify-instructions/07-01-SUMMARY.md

@src/adapters/__tests__/instructions.test.ts
@src/cli/__tests__/render.test.ts
@src/cli/__tests__/orchestrator.test.ts
@src/cli/__tests__/check.test.ts
@src/adapters/base.ts
@src/cli/canonical.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update all test files for new instruction signatures</name>
  <files>
    src/adapters/__tests__/instructions.test.ts
    src/cli/__tests__/render.test.ts
    src/cli/__tests__/orchestrator.test.ts
    src/cli/__tests__/check.test.ts
  </files>
  <action>
**1. Update `src/adapters/__tests__/instructions.test.ts`:**

All tests currently call `adapter.renderInstructions(base, addendum)` with two params. Change to single param:
- `adapter.renderInstructions(content)` where `content` is the full merged string.
- Remove tests that verify "base comes before addendum" order or "separator is double newline between base and addendum" — those concepts no longer apply.
- Update the "concatenates base + addendum" test to verify identity passthrough: `const content = '# Full\n\nContent.'; expect(adapter.renderInstructions(content)).toBe(content);`
- Keep the "outputs end with newline" test but adapt: if content ends with newline, output should too (since it's identity passthrough now, input = output).
- Keep the `expandPaths` helper tests at the bottom — they're unrelated to renderInstructions.

Simplified test structure:
```typescript
describe('renderInstructions (all adapters)', () => {
  for (const adapter of adapters) {
    describe(adapter.displayName, () => {
      test('returns content unchanged (identity passthrough)', () => {
        const content = '# Agent OS\n\nBase content.\n\n## CLI-Specific Notes\n\nPer-CLI stuff.\n';
        const result = adapter.renderInstructions(content);
        expect(result).toBe(content);
      });
    });
  }
});
```

**2. Update `src/cli/__tests__/render.test.ts`:**

The test at ~line 30-37 calls `readCanonicalInstructions(projectDir, 'claude-code')` and then `adapter.renderInstructions(instructions!.base, instructions!.addendum)`.

Change to:
```typescript
test('renders instructions for a target', async () => {
  const content = await readCanonicalInstructions(projectDir);
  expect(content).not.toBeNull();

  const adapter = createAdapter('claude-code');
  const rendered = adapter.renderInstructions(content!);
  expect(rendered.length).toBeGreaterThan(0);
});
```

Note: This test uses the real project directory. The `readCanonicalInstructions` will look for `configs/instructions/AGENTS.md` which was created in Plan 01.

**3. Update `src/cli/__tests__/orchestrator.test.ts`:**

The `setupProject` function (~line 10-38) writes:
- `join(dir, 'AGENTS.md')` — base instructions
- `join(instructionsDir, 'claude.md')` — addendum

Change `setupProject` to write a single unified file:
- Remove `await writeFile(join(dir, 'AGENTS.md'), ...)` (no repo-root AGENTS.md)
- Change `await writeFile(join(instructionsDir, 'claude.md'), ...)` to write `join(instructionsDir, 'AGENTS.md')` instead
- Content should be unified: `# Agent OS ${salt}\n\nBase.\n\n## CLI-Specific Notes\n\n### Claude Code\n\nClaude-specific ${salt}.\n`

**4. Update `src/cli/__tests__/check.test.ts`:**

Search for any references to the old 2-sourceItem instruction pattern or addendum-related assertions. The check tests may assert on instruction item counts — if they count addendum as a separate item, reduce by 1. Search for `instruction/` in assertions and update if needed. If check.test.ts has `mapTypes(['instructions'])` tests — those are about CLI flag parsing and should remain unchanged.
  </action>
  <verify>
`bun test src/adapters/__tests__/instructions.test.ts` — all tests pass.
`bun test src/cli/__tests__/render.test.ts` — all tests pass.
`bun test src/cli/__tests__/orchestrator.test.ts` — all tests pass.
`bun test src/cli/__tests__/check.test.ts` — all tests pass.
  </verify>
  <done>
All 4 test files updated for single-param renderInstructions and single-file readCanonicalInstructions. All test files pass individually.
  </done>
</task>

<task type="auto">
  <name>Task 2: Delete addendum files, remove repo-root AGENTS.md, verify clean state</name>
  <files>
    configs/instructions/claude.md
    configs/instructions/opencode.md
    configs/instructions/gemini.md
    configs/instructions/codex.md
    AGENTS.md
  </files>
  <action>
**1. Delete the 4 per-CLI addendum files:**
```bash
rm configs/instructions/claude.md
rm configs/instructions/opencode.md
rm configs/instructions/gemini.md
rm configs/instructions/codex.md
```

**2. Delete repo-root AGENTS.md:**

The canonical location is now `configs/instructions/AGENTS.md`. The repo root should NOT have AGENTS.md.
```bash
rm AGENTS.md
```

Note: The repo-root AGENTS.md content was already copied into `configs/instructions/AGENTS.md` in Plan 01.

**3. Verify `configs/instructions/` contains only AGENTS.md:**
```bash
ls configs/instructions/
# Expected: AGENTS.md (and nothing else)
```

**4. Run full test suite:**
```bash
bun test
```
All tests must pass. If any test reads repo-root AGENTS.md or per-CLI addendum files, it should have been fixed in Task 1.

**5. Verify no stale references:**
```bash
grep -r "configs/instructions/claude.md\|configs/instructions/opencode.md\|configs/instructions/gemini.md\|configs/instructions/codex.md" src/ --include="*.ts"
```
Should return 0 hits (excluding test fixtures that create temp files).

```bash
grep -rn "OPENCODE.md\|GEMINI.md" src/ --include="*.ts" | grep -v node_modules | grep -v __tests__
```
Should return 0 hits in non-test source files (path-resolver was already updated in Plan 01).

**6. Run acsync check to verify the new pipeline works:**
```bash
bun run src/cli/index.ts check --type instructions --pretty
```
This should show drift (because target files have old names like OPENCODE.md but we now write AGENTS.md). The drift direction confirms the pipeline is working correctly with new filenames.
  </action>
  <verify>
`ls configs/instructions/` shows only `AGENTS.md`.
`test ! -f AGENTS.md && echo "OK"` — repo-root AGENTS.md is gone.
`test ! -f configs/instructions/claude.md && echo "OK"` — addendum deleted.
`bun test` — all tests pass (0 failures).
`grep -r "addendum" src/ --include="*.ts" | grep -v node_modules | grep -v __tests__` returns 0 hits in non-test source files.
  </verify>
  <done>
4 addendum files deleted. Repo-root AGENTS.md deleted. configs/instructions/ contains only AGENTS.md. Full test suite passes. No stale references in source code.
  </done>
</task>

</tasks>

<verification>
- `bun test` — full suite passes with 0 failures
- `ls configs/instructions/` — only AGENTS.md
- `test ! -f AGENTS.md` — no repo-root AGENTS.md
- `test ! -f configs/instructions/claude.md` — no addendum files
- `grep -r "addendumMd\|addendum" src/ --include="*.ts" | grep -v __tests__` — 0 hits in non-test source
- `bun run src/cli/index.ts check --type instructions` — runs without error
</verification>

<success_criteria>
1. All tests pass (0 failures)
2. No per-CLI addendum files exist in configs/instructions/
3. No AGENTS.md at repo root
4. acsync check --type instructions runs successfully
5. No stale references to old addendum files or old filenames in source code
</success_criteria>

<output>
After completion, create `.planning/phases/07-unify-instructions/07-02-SUMMARY.md`
</output>
