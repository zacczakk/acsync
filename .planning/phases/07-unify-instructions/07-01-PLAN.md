---
phase: 07-unify-instructions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - configs/instructions/AGENTS.md
  - src/adapters/base.ts
  - src/adapters/path-resolver.ts
  - src/cli/canonical.ts
  - src/cli/check.ts
  - src/cli/push.ts
  - src/cli/render.ts
  - src/cli/diff.ts
autonomous: true
requirements: [INST-01, INST-02, INST-03, INST-04, INST-05, INST-06, INST-07, INST-08, INST-09, INST-10]

must_haves:
  truths:
    - "configs/instructions/AGENTS.md exists with ## CLI-Specific Notes section containing merged addendum content"
    - "readCanonicalInstructions returns single string content (no base/addendum split)"
    - "renderInstructions accepts single content param (no addendum)"
    - "path-resolver returns correct output filenames: CLAUDE.md, AGENTS.md, AGENTS.md, AGENTS.md for claude/opencode/gemini/codex"
    - "All CLI commands (check, push, render, diff) use simplified single-content instruction flow"
    - "No per-CLI addendum files exist in configs/instructions/"
    - "No AGENTS.md at repo root"
  artifacts:
    - path: "configs/instructions/AGENTS.md"
      provides: "Unified instructions with CLI-Specific Notes section"
      contains: "## CLI-Specific Notes"
    - path: "src/cli/canonical.ts"
      provides: "Simplified readCanonicalInstructions reading single file"
      exports: ["readCanonicalInstructions"]
    - path: "src/adapters/base.ts"
      provides: "Simplified renderInstructions with single param"
      exports: ["ToolAdapter", "BaseAdapter"]
    - path: "src/adapters/path-resolver.ts"
      provides: "Corrected output filenames for all 4 targets"
  key_links:
    - from: "src/cli/canonical.ts"
      to: "configs/instructions/AGENTS.md"
      via: "readCanonicalInstructions reads single file"
      pattern: "readFile.*INSTRUCTIONS_DIR.*AGENTS\\.md"
    - from: "src/cli/check.ts"
      to: "src/adapters/base.ts"
      via: "adapter.renderInstructions(content)"
      pattern: "renderInstructions\\("
    - from: "src/adapters/path-resolver.ts"
      to: "target filesystem"
      via: "getInstructionsPath returns per-target filename"
      pattern: "AGENTS\\.md|CLAUDE\\.md"
---

<objective>
Unify 4 per-CLI instruction addendums into a single canonical AGENTS.md and simplify the entire rendering pipeline to single-file passthrough.

Purpose: Eliminate addendum complexity — one file to edit, one function to render, correct output filenames for all targets.
Output: Unified configs/instructions/AGENTS.md, simplified rendering pipeline, correct target filenames.
</objective>

<execution_context>
@/Users/m332023/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/m332023/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-flatten-canonical-structure/06-01-SUMMARY.md

@src/cli/canonical.ts
@src/adapters/base.ts
@src/adapters/path-resolver.ts
@src/cli/check.ts
@src/cli/push.ts
@src/cli/render.ts
@src/cli/diff.ts
@AGENTS.md
@configs/instructions/claude.md
@configs/instructions/opencode.md
@configs/instructions/gemini.md
@configs/instructions/codex.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create unified AGENTS.md and simplify rendering functions</name>
  <files>
    configs/instructions/AGENTS.md
    src/cli/canonical.ts
    src/adapters/base.ts
  </files>
  <action>
**1. Create `configs/instructions/AGENTS.md`:**

Copy the entire content of repo-root `AGENTS.md` into `configs/instructions/AGENTS.md`. Then append a `## CLI-Specific Notes` section at the end. Under this section, merge content from all 4 addendum files using subsections:

```markdown
## CLI-Specific Notes

### Claude Code

{content from configs/instructions/claude.md, excluding its H1 heading "# Claude Code Addendum"}

### OpenCode

{content from configs/instructions/opencode.md, excluding its H1 heading "# OpenCode Addendum"}

### Gemini

{content from configs/instructions/gemini.md, excluding its H1 heading "# Gemini Addendum"}

### Codex

{content from configs/instructions/codex.md, excluding its H1 heading "# Codex Addendum"}
```

Keep the subsection headings as H3 (`###`) to nest under the H2 `## CLI-Specific Notes`.

**2. Simplify `readCanonicalInstructions()` in `src/cli/canonical.ts`:**

Change signature from:
```typescript
export async function readCanonicalInstructions(
  projectDir: string,
  target: TargetName,
): Promise<{ base: string; addendum: string } | null>
```

To:
```typescript
export async function readCanonicalInstructions(
  projectDir: string,
): Promise<string | null>
```

Implementation: Read single file from `join(projectDir, INSTRUCTIONS_DIR, 'AGENTS.md')`. Return the file content as a string, or null if not found. Remove the `target` parameter entirely — no addendum lookup needed. Remove the `TargetName` import if no longer used in this file.

**3. Simplify `renderInstructions()` in `src/adapters/base.ts`:**

Change the `ToolAdapter` interface method from:
```typescript
renderInstructions(baseMd: string, addendumMd: string): string;
```

To:
```typescript
renderInstructions(content: string): string;
```

Update `BaseAdapter.renderInstructions` implementation: simply return `content` (identity passthrough — the content is already complete since addendums are merged). Remove the concatenation logic (`baseMd + '\n\n' + addendumMd + '\n'`). The new implementation is:
```typescript
renderInstructions(content: string): string {
  return content;
}
```

Update the JSDoc comment on both the interface method and the implementation to say "Render instructions (identity passthrough — content is already unified)".
  </action>
  <verify>
`grep -r "addendumMd\|addendum" src/cli/canonical.ts src/adapters/base.ts` returns 0 hits.
`grep "readCanonicalInstructions" src/cli/canonical.ts` shows single-param signature.
`cat configs/instructions/AGENTS.md | grep "## CLI-Specific Notes"` returns a match.
  </verify>
  <done>
configs/instructions/AGENTS.md exists with ## CLI-Specific Notes section containing merged content from all 4 addendums. readCanonicalInstructions takes only projectDir (no target). renderInstructions takes single content param.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update path-resolver output filenames and all CLI callers</name>
  <files>
    src/adapters/path-resolver.ts
    src/cli/check.ts
    src/cli/push.ts
    src/cli/render.ts
    src/cli/diff.ts
  </files>
  <action>
**1. Update `rawInstructionsPath()` in `src/adapters/path-resolver.ts`:**

Change output filenames:
```typescript
private rawInstructionsPath(): string {
  switch (this.target) {
    case 'claude-code': return '~/.claude/CLAUDE.md';       // unchanged
    case 'opencode':    return '~/.config/opencode/AGENTS.md';  // was OPENCODE.md
    case 'gemini':      return '~/.gemini/AGENTS.md';           // was GEMINI.md
    case 'codex':       return '~/.codex/AGENTS.md';            // was instructions.md
  }
}
```

**2. Update `src/cli/check.ts`:**

Change the instructions section (~line 224-252):
- Remove the `target` argument from `readCanonicalInstructions(projectDir, target)` → `readCanonicalInstructions(projectDir)`
- The return type is now `string | null` (not `{ base, addendum }`), so:
  - `const content = await readCanonicalInstructions(projectDir);`
  - `if (content) { const rendered = adapter.renderInstructions(content); ... }`
- Remove the addendum-specific sourceItem push block (lines 241-252 that check `if (instructions.addendum)` and push a second sourceItem for the addendum name). Only one sourceItem for instructions per target.
- Keep the sourceItem name as `'instructions'` (since there's now just one file).

**3. Update `src/cli/push.ts`:**

Change the instructions block (~line 134-137):
- `const content = await readCanonicalInstructions(projectDir);`
- `if (!content) continue;`
- `const rendered = adapter.renderInstructions(content);`
- Assign `rendered` to the outer `content` variable for atomicWrite.

**4. Update `src/cli/render.ts`:**

Change the instructions rendering (~line 91-95):
- `const content = await readCanonicalInstructions(projectDir);`
- `if (!content) { ... error ... }`
- `rendered = adapter.renderInstructions(content);`
- Remove the `target` param from the call.

**5. Update `src/cli/diff.ts`:**

Change the instructions rendering (~line 105-107):
- `const content = await readCanonicalInstructions(projectDir);`
- `if (!content) continue;`
- `rendered = adapter.renderInstructions(content);`
- Remove the `target` param from the call.

For all files: ensure the import of `readCanonicalInstructions` from `./canonical` is preserved. If any file imported `TargetName` only for the readCanonicalInstructions call, check if it's still needed elsewhere before removing.
  </action>
  <verify>
`bun test src/` — expect test failures (tests not yet updated, that's Plan 02). But NO TypeScript compilation errors: `bun build --no-bundle src/cli/check.ts src/cli/push.ts src/cli/render.ts src/cli/diff.ts` should succeed (or use `bunx tsc --noEmit` if available).
`grep -r "readCanonicalInstructions.*target\|readCanonicalInstructions.*projectDir.*target" src/cli/` returns 0 hits.
`grep "OPENCODE.md\|GEMINI.md\|instructions.md" src/adapters/path-resolver.ts` returns 0 hits.
  </verify>
  <done>
All 4 CLI commands use simplified readCanonicalInstructions(projectDir) with single-param renderInstructions(content). Path resolver returns CLAUDE.md for Claude and AGENTS.md for the other 3 targets.
  </done>
</task>

</tasks>

<verification>
- `grep -r "addendumMd\|addendum" src/` should only hit test files (updated in Plan 02) and possibly old addendum files (deleted in Plan 02)
- `grep "OPENCODE.md" src/adapters/path-resolver.ts` returns 0 hits
- `grep "GEMINI.md" src/adapters/path-resolver.ts` returns 0 hits
- `grep "instructions.md" src/adapters/path-resolver.ts` returns 0 hits
- `cat configs/instructions/AGENTS.md | head -5` shows the base content
- `cat configs/instructions/AGENTS.md | grep "## CLI-Specific Notes"` returns a match
- TypeScript compiles without errors
</verification>

<success_criteria>
1. configs/instructions/AGENTS.md exists with merged content including ## CLI-Specific Notes
2. readCanonicalInstructions signature simplified to (projectDir) → string | null
3. renderInstructions signature simplified to (content) → string
4. Path resolver returns correct target filenames (CLAUDE.md, AGENTS.md ×3)
5. All CLI commands updated to new signatures
6. No TypeScript compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-unify-instructions/07-01-SUMMARY.md`
</output>
