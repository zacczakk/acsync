---
phase: 11-push-e2e-tests
plan: 02
type: execute
wave: 2
depends_on: [11-01]
files_modified:
  - src/cli/__tests__/push-commands.test.ts
  - src/cli/__tests__/push-agents.test.ts
  - src/cli/__tests__/push-skills.test.ts
autonomous: true
requirements: [PUSH-01, PUSH-02, PUSH-03, PUSH-07]

must_haves:
  truths:
    - "Pushing commands to all 4 targets produces files matching golden fixtures exactly"
    - "Pushing agents to all 4 targets produces files matching golden fixtures exactly"
    - "Pushing skills to all 4 targets (that support skills) produces files matching golden fixtures exactly"
    - "Push with --force --delete removes stale command/agent/skill files from targets"
    - "Second push of same content reports 0 drift (idempotent)"
    - "OrchestratorPushResult reports correct written count, hasDrift, rolledBack=false"
  artifacts:
    - path: "src/cli/__tests__/push-commands.test.ts"
      provides: "E2E push tests for commands config type across all 4 targets"
      min_lines: 80
    - path: "src/cli/__tests__/push-agents.test.ts"
      provides: "E2E push tests for agents config type across all 4 targets"
      min_lines: 80
    - path: "src/cli/__tests__/push-skills.test.ts"
      provides: "E2E push tests for skills config type across all 4 targets"
      min_lines: 80
  key_links:
    - from: "src/cli/__tests__/push-commands.test.ts"
      to: "test/fixtures/canonical/"
      via: "runPush with projectDir pointing to fixture canonical"
      pattern: "runPush.*projectDir"
    - from: "src/cli/__tests__/push-commands.test.ts"
      to: "test/fixtures/{target}/commands/"
      via: "readFileSync golden comparison"
      pattern: "readFileSync.*fixtures.*commands"
    - from: "src/cli/__tests__/push-commands.test.ts"
      to: "test/helpers/backup.ts"
      via: "withTargetBackup wrapping all test execution"
      pattern: "withTargetBackup"
---

<objective>
Write E2E push tests for commands, agents, and skills — the 3 config types where golden fixtures already exist from Phase 10.

Purpose: Cover PUSH-01 (commands), PUSH-02 (agents), PUSH-03 (skills), and part of PUSH-07 (stale removal) with golden-file-based E2E tests that push canonical fixtures to real target directories and compare output.
Output: 3 test files in `src/cli/__tests__/` covering 12 push cells (3 types × 4 targets) plus stale removal and idempotency.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-push-e2e-tests/11-01-SUMMARY.md

@src/cli/push.ts
@src/cli/canonical.ts
@src/cli/check.ts
@test/helpers/backup.ts
@test/fixtures/canonical/commands/groom-docs.md
@test/fixtures/claude/commands/groom-docs.md
@test/fixtures/opencode/commands/groom-docs.md
@test/fixtures/gemini/commands/groom-docs.toml
@test/fixtures/codex/commands/groom-docs.md
@src/adapters/base.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write push-commands.test.ts E2E test</name>
  <files>src/cli/__tests__/push-commands.test.ts</files>
  <action>
    Create `src/cli/__tests__/push-commands.test.ts` with this structure:

    **Setup:**
    - Import `withTargetBackup` from `test/helpers/backup.ts`, `runPush` from `../push`, `runCheck` from `../check`
    - Import `readFileSync` from `node:fs`, `join` from `node:path`, `homedir` from `node:os`
    - Define `FIXTURE_ROOT = join(import.meta.dir, '../../../test/fixtures')` for golden file paths
    - Define `PROJECT_DIR` pointing to a temp copy of `test/fixtures/canonical/` structured as a proper project dir (with `configs/` subdirectory). The test needs `configs/commands/` inside projectDir. Create a helper `setupProjectDir()` that copies `test/fixtures/canonical/` into a temp dir under `configs/` so runPush sees it as a real project.

    **Main describe block:** `describe('push-commands E2E', () => { ... })`

    Wrap ALL test execution in a single `withTargetBackup(async () => { ... })` call. Inside, first run `runPush({ projectDir, force: true, types: ['command'] })` once, then run all assertions.

    **Assertions per target (4 targets × 1 config type = 4 cells):**
    For each target (claude-code, opencode, gemini, codex):
    - Read the pushed file from the real target directory (use adapter getPaths or hardcode known paths: `~/.claude/commands/groom-docs.md`, `~/.config/opencode/commands/groom-docs.md`, `~/.gemini/commands/groom-docs.toml`, `~/.codex/prompts/groom-docs.md`)
    - Read the golden fixture from `test/fixtures/{target}/commands/groom-docs.{ext}`
    - Assert exact string match: `expect(pushed).toBe(golden)`

    **OrchestratorPushResult assertions:**
    - `expect(result.written).toBeGreaterThan(0)` (at least 4 files — 1 command × 4 targets)
    - `expect(result.rolledBack).toBe(false)`
    - `expect(result.failed).toBe(0)`

    **Idempotency test:**
    Push again with same options. Assert second result has `written === 0` or `hasDrift === false`.

    **Stale removal test (separate withTargetBackup block):**
    1. Push commands once (force: true)
    2. Write a stale file to one target: e.g., `~/.claude/commands/stale-test-file.md` with dummy content
    3. Push again with `force: true, deleteStale: true, types: ['command']`
    4. Assert stale file is gone: `existsSync(stalePath)` is false
    5. Assert canonical command file still exists

    **Pattern notes:**
    - Use `test()` (not `it()`) — matches existing bun:test convention in the codebase
    - Codex commands go to `~/.codex/prompts/` (not commands/) — check adapter path
    - Gemini commands use `.toml` extension
  </action>
  <verify>
    - `bun test src/cli/__tests__/push-commands.test.ts` passes
    - At least 6 test assertions (4 golden comparisons + result assertions + idempotency + stale)
    - `bun test` passes with 0 failures
  </verify>
  <done>
    push-commands.test.ts covers all 4 targets with golden comparison, result object assertions, idempotency, and stale removal for the commands config type.
  </done>
</task>

<task type="auto">
  <name>Task 2: Write push-agents.test.ts and push-skills.test.ts E2E tests</name>
  <files>
    src/cli/__tests__/push-agents.test.ts
    src/cli/__tests__/push-skills.test.ts
  </files>
  <action>
    Create both files following the same pattern as push-commands.test.ts from Task 1.

    **push-agents.test.ts:**
    - Same setup pattern: `setupProjectDir()`, `withTargetBackup`, single push call
    - Push with `types: ['agent']`
    - Golden comparison for all 4 targets:
      - Claude: `~/.claude/agents/test-agent.md` vs `test/fixtures/claude/agents/test-agent.md`
      - OpenCode: `~/.config/opencode/agents/test-agent.md` vs `test/fixtures/opencode/agents/test-agent.md`
      - Gemini: `~/.gemini/agents/test-agent.md` vs `test/fixtures/gemini/agents/test-agent.md`
      - Codex: `~/.codex/prompts/agent-test-agent.md` vs `test/fixtures/codex/agents/agent-test-agent.md` (Codex prefixes agents with `agent-` and puts them in prompts/)
    - OrchestratorPushResult assertions (written > 0, failed === 0, rolledBack === false)
    - Idempotency: push twice, second has no drift
    - Stale removal: write stale agent file, push with deleteStale, verify removed

    **push-skills.test.ts:**
    - Same pattern but with `types: ['skill']`
    - Skills go to `{target}/skills/{name}/SKILL.md` directories
    - Golden comparison for targets that support skills (Claude has `caps.skills = true` — wait, check adapter capabilities):
      - Claude: `~/.claude/skills/obsidian/SKILL.md`
      - OpenCode: `~/.config/opencode/skills/obsidian/SKILL.md`  
      - Gemini: `~/.gemini/skills/obsidian/SKILL.md`
      - Codex: `~/.codex/skills/obsidian/SKILL.md`
    - Skills are identity passthrough (same content for all targets)
    - Also test web-design-guidelines skill (second skill in canonical fixtures)
    - Stale removal for skills removes the entire skill directory (not just SKILL.md)
    - Idempotency test

    **Shared pattern to extract:** If repetitive setup code (setupProjectDir, fixture path helpers) is substantial, create a shared helper at the top of each file or in a small utility. Use Claude's discretion — if it's just 5-10 lines, inline is fine.
  </action>
  <verify>
    - `bun test src/cli/__tests__/push-agents.test.ts` passes
    - `bun test src/cli/__tests__/push-skills.test.ts` passes
    - Each has golden comparison for all 4 targets
    - Each has idempotency + stale removal tests
    - `bun test` passes with 0 failures
  </verify>
  <done>
    push-agents.test.ts and push-skills.test.ts each cover all 4 targets with golden comparison, result assertions, idempotency, and stale removal. Combined with push-commands.test.ts, 12 of 24 push cells are covered.
  </done>
</task>

</tasks>

<verification>
- All 3 test files exist and pass independently
- Golden file comparisons cover 12 push cells (commands × 4, agents × 4, skills × 4)
- Each file tests stale removal (PUSH-07 partial)
- Each file tests idempotency
- `bun test` full suite passes with 0 failures
</verification>

<success_criteria>
- 3 new test files in src/cli/__tests__/
- 12 push cells covered (3 types × 4 targets) with golden comparison
- OrchestratorPushResult assertions in each file
- Stale removal verified per type
- Idempotency verified per type
- Full test suite green
</success_criteria>

<output>
After completion, create `.planning/phases/11-push-e2e-tests/11-02-SUMMARY.md`
</output>
