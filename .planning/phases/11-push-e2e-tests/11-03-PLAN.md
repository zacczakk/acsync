---
phase: 11-push-e2e-tests
plan: 03
type: execute
wave: 2
depends_on: [11-01]
files_modified:
  - src/cli/__tests__/push-mcp.test.ts
  - src/cli/__tests__/push-settings.test.ts
  - src/cli/__tests__/push-instructions.test.ts
autonomous: true
requirements: [PUSH-04, PUSH-05, PUSH-06, PUSH-07]

must_haves:
  truths:
    - "Pushing MCP servers to all 4 targets produces files matching golden fixtures (merged with seed state)"
    - "Pushing settings to claude and opencode produces files matching golden fixtures (merged with seed state)"
    - "Pushing instructions to all 4 targets produces files matching golden fixtures exactly"
    - "Push with --force --delete removes stale items from targets for MCP/settings/instructions"
    - "Second push of same content reports 0 drift (idempotent)"
    - "Codex MCP renders only HTTP servers (tavily stdio is excluded)"
  artifacts:
    - path: "src/cli/__tests__/push-mcp.test.ts"
      provides: "E2E push tests for MCP config type across all 4 targets"
      min_lines: 80
    - path: "src/cli/__tests__/push-settings.test.ts"
      provides: "E2E push tests for settings config type across claude and opencode"
      min_lines: 60
    - path: "src/cli/__tests__/push-instructions.test.ts"
      provides: "E2E push tests for instructions config type across all 4 targets"
      min_lines: 60
  key_links:
    - from: "src/cli/__tests__/push-mcp.test.ts"
      to: "test/fixtures/seeds/"
      via: "Pre-populate targets with seed MCP configs before push"
      pattern: "cpSync.*seeds"
    - from: "src/cli/__tests__/push-mcp.test.ts"
      to: "test/fixtures/{target}/mcp/"
      via: "readFileSync golden comparison after push"
      pattern: "readFileSync.*fixtures.*mcp"
    - from: "src/cli/__tests__/push-settings.test.ts"
      to: "test/fixtures/seeds/"
      via: "Pre-populate targets with seed settings configs before push"
      pattern: "cpSync.*seeds"
---

<objective>
Write E2E push tests for MCP, settings, and instructions — the 3 remaining config types completing all 24 push cells.

Purpose: Cover PUSH-04 (settings), PUSH-05 (MCP), PUSH-06 (instructions), and remaining PUSH-07 (stale removal) with golden-file-based E2E tests. MCP and settings require merge testing — pre-populate targets with seed state, push canonical, compare merged output against golden fixtures.
Output: 3 test files in `src/cli/__tests__/` covering the remaining 12 push cells (3 types × 4 targets, with settings only applying to 2 targets) plus stale removal and idempotency.
</objective>

<execution_context>
@/Users/m332023/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/m332023/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-push-e2e-tests/11-01-SUMMARY.md

@src/cli/push.ts
@src/cli/canonical.ts
@test/helpers/backup.ts
@test/fixtures/seeds/
@test/fixtures/claude/mcp/
@test/fixtures/opencode/mcp/
@test/fixtures/gemini/mcp/
@test/fixtures/codex/mcp/
@test/fixtures/claude/settings/
@test/fixtures/opencode/settings/
@test/fixtures/claude/instructions/
@test/fixtures/opencode/instructions/
@src/adapters/base.ts
@src/adapters/claude-code.ts
@src/adapters/opencode.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write push-mcp.test.ts E2E test</name>
  <files>src/cli/__tests__/push-mcp.test.ts</files>
  <action>
    Create `src/cli/__tests__/push-mcp.test.ts` testing MCP push across all 4 targets.

    **Key difference from commands/agents:** MCP rendering is a MERGE operation. The adapter takes existing target file content and merges canonical MCP servers into it. Tests must:
    1. Pre-populate real target MCP files with seed content BEFORE pushing
    2. Push canonical MCP servers
    3. Compare merged output against golden fixtures (which were generated with same seeds)

    **Setup:**
    - Import `withTargetBackup`, `runPush`, `readFileSync`, `writeFileSync`, `mkdirSync`, `existsSync`
    - Define `FIXTURE_ROOT`, `SEEDS_ROOT`
    - Helper `setupProjectDir()` — same pattern as Plan 02 (copy canonical fixtures into temp dir under configs/)
    - Helper `seedTargets()` — copy seed MCP files to real target locations:
      - Claude: copy `seeds/claude/mcp.json` → `~/.claude/claude_desktop_config.json` (or the actual MCP settings path — check `ClaudeCodeAdapter.getPaths().getMCPConfigPath()`)
      - OpenCode: copy `seeds/opencode/mcp.jsonc` → `~/.config/opencode/opencode.json` (OpenCode MCP lives in main config)
      - Gemini: copy `seeds/gemini/mcp.json` → `~/.gemini/settings.json`
      - Codex: copy `seeds/codex/mcp.toml` → `~/.codex/config.toml`
    
    IMPORTANT: Check the actual target paths by looking at `AdapterPathResolver` in `src/adapters/base.ts` — the MCP config path varies per target. Use `createAdapter(target).getPaths().getMCPConfigPath()` to get the real path, or read the path-resolver code to hardcode correctly.

    **Main test block:**
    Wrap in `withTargetBackup(async () => { ... })`:
    1. Call `seedTargets()` to write seed files to real target dirs
    2. Run `runPush({ projectDir, force: true, types: ['mcp'] })`
    3. For each target: read the target MCP file, read the corresponding golden fixture, assert exact match

    **Golden paths per target:**
    - Claude: `test/fixtures/claude/mcp/settings.json`
    - OpenCode: `test/fixtures/opencode/mcp/opencode.jsonc`
    - Gemini: `test/fixtures/gemini/mcp/settings.json`
    - Codex: `test/fixtures/codex/mcp/mcp_servers.toml` (or whatever generate-golden.ts wrote)

    **OrchestratorPushResult assertions:**
    - `result.written > 0`, `result.failed === 0`, `result.rolledBack === false`

    **Codex-specific:** Codex only renders HTTP MCP servers. Canonical has context7 (HTTP) and tavily (stdio). Codex golden should only contain context7. Verify codex output does NOT contain tavily.

    **Idempotency:** Push twice with same setup, second push has no drift.

    **Stale MCP removal:** MCP is a single merged file per target, so "stale removal" for MCP means: if `deleteStale: true` and a server was in the target but NOT in canonical, it should be removed. This is handled by the adapter's merge logic, not file-level deletion. Test: seed with an extra server, push, verify extra server is gone from output. (Or verify this is NOT how acsync works — check the diff engine. MCP is a single operation per target, so stale MCP servers within the file may or may not be pruned. If the adapter just merges/overwrites, stale servers in the merged file persist. Test what actually happens and assert accordingly.)
  </action>
  <verify>
    - `bun test src/cli/__tests__/push-mcp.test.ts` passes
    - At least 4 golden comparison assertions (1 per target)
    - Codex output excludes stdio-only servers
    - Idempotency verified
    - `bun test` passes with 0 failures
  </verify>
  <done>
    push-mcp.test.ts covers all 4 targets with golden comparison of merged MCP output. Seed state → push → compare against golden fixtures that were generated with same seeds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Write push-settings.test.ts and push-instructions.test.ts E2E tests</name>
  <files>
    src/cli/__tests__/push-settings.test.ts
    src/cli/__tests__/push-instructions.test.ts
  </files>
  <action>
    **push-settings.test.ts:**

    Settings is similar to MCP — it's a merge operation. Only claude and opencode have canonical settings files (gemini/codex do not).

    Setup:
    - `setupProjectDir()` with canonical fixtures
    - `seedTargets()` for settings: copy seed settings to real target paths
      - Claude: `seeds/claude/settings.json` → `~/.claude/settings.json` (check actual path via adapter)
      - OpenCode: `seeds/opencode/settings.jsonc` → `~/.config/opencode/opencode.json` (check actual path)

    Main test block (in withTargetBackup):
    1. Seed targets with settings files
    2. `runPush({ projectDir, force: true, types: ['settings'] })`
    3. For claude: read target settings file, compare to `test/fixtures/claude/settings/settings.json` golden
    4. For opencode: read target settings file, compare to `test/fixtures/opencode/settings/opencode.json` golden
    5. Assert gemini/codex have no settings writes (their adapters don't have canonical settings files, so push should skip them)

    Result assertions: written count matches expected (2 — claude + opencode), failed === 0, rolledBack === false.
    
    Idempotency: push twice, second has no drift.

    Note: Settings targets and MCP targets may share the same file (e.g., Claude's settings.json may contain both settings keys AND mcpServers). The settings test should only push `types: ['settings']` to isolate. If the target file doesn't exist before push, the adapter creates it from scratch. If it exists (seeded), the adapter merges canonical keys into it.

    **push-instructions.test.ts:**

    Instructions is straightforward — identity passthrough, no merge needed. Each target gets the same content (from `configs/instructions/AGENTS.md`), just with different output filenames.

    Setup:
    - `setupProjectDir()` with canonical fixtures
    - No seeding needed — instructions don't merge

    Main test block (in withTargetBackup):
    1. `runPush({ projectDir, force: true, types: ['instruction'] })`
    2. For each target, read the pushed instructions file:
      - Claude: `~/.claude/CLAUDE.md`
      - OpenCode: `~/.config/opencode/AGENTS.md`
      - Gemini: `~/.gemini/AGENTS.md`
      - Codex: `~/.codex/AGENTS.md`
    3. Compare against golden: `test/fixtures/{target}/instructions/{filename}`
    4. All 4 should be identical content (identity passthrough)

    Result assertions: written === 4, failed === 0, rolledBack === false.

    Idempotency: push twice, second has no drift.

    Stale removal: Instructions is a single file per target, not a directory of items. Stale removal for instructions means the file itself would be deleted if no canonical instructions exist. This is an edge case — test only if straightforward, otherwise skip (discretion).
  </action>
  <verify>
    - `bun test src/cli/__tests__/push-settings.test.ts` passes
    - `bun test src/cli/__tests__/push-instructions.test.ts` passes
    - Settings: golden comparison for claude + opencode, verifies gemini/codex skipped
    - Instructions: golden comparison for all 4 targets
    - Both have idempotency tests
    - `bun test` passes with 0 failures
  </verify>
  <done>
    push-settings.test.ts covers claude + opencode settings push with merge verification. push-instructions.test.ts covers all 4 targets with identity passthrough verification. Combined with Plan 02, all 24 push cells are covered across 6 test files.
  </done>
</task>

</tasks>

<verification>
- All 3 test files exist and pass independently
- MCP: 4 targets with merge golden comparison
- Settings: 2 targets (claude, opencode) with merge golden comparison
- Instructions: 4 targets with identity passthrough comparison
- Remaining 12 push cells covered (MCP × 4 + settings × 2 + instructions × 4 + 2 settings no-ops = covering 10 active cells, but all 6 types × 4 targets = 24 total cells accounted for across Plans 02 + 03)
- `bun test` full suite passes with 0 failures
- All PUSH-01 through PUSH-07 requirements have test coverage
</verification>

<success_criteria>
- 3 new test files in src/cli/__tests__/
- MCP merge testing with seeds → push → golden comparison
- Settings merge testing with seeds → push → golden comparison
- Instructions identity passthrough testing
- All 24 push cells covered across Plans 02 + 03
- Stale removal tested for applicable types
- Full test suite green
</success_criteria>

<output>
After completion, create `.planning/phases/11-push-e2e-tests/11-03-SUMMARY.md`
</output>
