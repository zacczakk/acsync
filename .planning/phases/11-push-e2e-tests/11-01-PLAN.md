---
phase: 11-push-e2e-tests
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - test/fixtures/seeds/claude/settings.json
  - test/fixtures/seeds/opencode/settings.jsonc
  - test/fixtures/seeds/claude/mcp.json
  - test/fixtures/seeds/opencode/mcp.jsonc
  - test/fixtures/seeds/gemini/mcp.json
  - test/fixtures/seeds/codex/mcp.toml
  - test/generate-golden.ts
  - test/fixtures/claude/mcp/settings.json
  - test/fixtures/opencode/mcp/opencode.jsonc
  - test/fixtures/gemini/mcp/settings.json
  - test/fixtures/codex/mcp/mcp_servers.toml
  - test/fixtures/claude/settings/settings.json
  - test/fixtures/opencode/settings/opencode.json
  - src/cli/__tests__/orchestrator.test.ts
autonomous: true
requirements: [PUSH-04, PUSH-05]

must_haves:
  truths:
    - "MCP golden fixtures exist for all 4 targets showing rendered MCP output merged into seed state"
    - "Settings golden fixtures exist for claude and opencode targets showing rendered settings merged into seed state"
    - "Seed files exist in test/fixtures/seeds/ with deterministic pre-existing target configs"
    - "generate-golden.ts can regenerate MCP and settings golden files"
    - "orchestrator.test.ts no longer has runPush tests (only runCheck remains)"
  artifacts:
    - path: "test/fixtures/seeds/"
      provides: "Pre-existing target configs for merge testing"
    - path: "test/generate-golden.ts"
      provides: "Extended generation for MCP + settings golden files"
    - path: "test/fixtures/claude/mcp/"
      provides: "Claude MCP golden output"
    - path: "test/fixtures/opencode/mcp/"
      provides: "OpenCode MCP golden output"
    - path: "test/fixtures/gemini/mcp/"
      provides: "Gemini MCP golden output"
    - path: "test/fixtures/codex/mcp/"
      provides: "Codex MCP golden output"
    - path: "test/fixtures/claude/settings/"
      provides: "Claude settings golden output"
    - path: "test/fixtures/opencode/settings/"
      provides: "OpenCode settings golden output"
  key_links:
    - from: "test/generate-golden.ts"
      to: "test/fixtures/seeds/"
      via: "Reads seed files as existingContent for renderMCPServers/renderSettings"
      pattern: "readFileSync.*seeds"
    - from: "test/generate-golden.ts"
      to: "test/fixtures/{target}/mcp/"
      via: "Writes rendered MCP output as golden files"
      pattern: "writeGolden.*mcp"
---

<objective>
Create seed fixtures for MCP and settings merge testing, extend golden file generation to cover MCP and settings types, and remove superseded push tests from orchestrator.test.ts.

Purpose: Phase 11 E2E tests need golden files for all 6 config types. Phase 10 generated goldens for commands, agents, skills, instructions but NOT MCP or settings (which require pre-existing target state for merge testing). This plan closes that gap and cleans up old push test coverage being replaced.
Output: Seed fixtures in `test/fixtures/seeds/`, MCP + settings golden fixtures in per-target dirs, extended `generate-golden.ts`, cleaned `orchestrator.test.ts`.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-fixtures-infrastructure-test-health/10-03-SUMMARY.md

@test/generate-golden.ts
@test/fixtures/canonical/mcp/context7.json
@test/fixtures/canonical/mcp/tavily.json
@test/fixtures/canonical/settings/claude.json
@test/fixtures/canonical/settings/opencode.json
@src/adapters/base.ts
@src/adapters/claude-code.ts
@src/adapters/opencode.ts
@src/adapters/gemini.ts
@src/adapters/codex.ts
@src/cli/__tests__/orchestrator.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create seed fixtures and extend golden generation for MCP + settings</name>
  <files>
    test/fixtures/seeds/claude/settings.json
    test/fixtures/seeds/opencode/settings.jsonc
    test/fixtures/seeds/claude/mcp.json
    test/fixtures/seeds/opencode/mcp.jsonc
    test/fixtures/seeds/gemini/mcp.json
    test/fixtures/seeds/codex/mcp.toml
    test/generate-golden.ts
  </files>
  <action>
    1. Create `test/fixtures/seeds/` directory structure with per-target pre-existing configs.

    **MCP seeds** — simulate existing target MCP configs that canonical servers merge INTO:
    - `seeds/claude/mcp.json`: Valid Claude settings JSON with an `mcpServers` key containing 1 pre-existing server (e.g., `{"mcpServers": {"existing-server": {"command": "node", "args": ["server.js"]}}}`)
    - `seeds/opencode/mcp.jsonc`: Valid OpenCode JSONC with an `mcp` key containing 1 pre-existing server and a JSONC comment at top (e.g., `// OpenCode MCP config\n{"mcp": {"existing-server": {"type": "local", "command": "node", "args": ["server.js"]}}}`)
    - `seeds/gemini/mcp.json`: Same shape as Claude — `{"mcpServers": {"existing-server": {"command": "node", "args": ["server.js"]}}}`
    - `seeds/codex/mcp.toml`: Codex MCP is TOML — `[mcp_servers.existing-server]\nurl = "https://example.com/mcp"\n` (Codex only renders HTTP servers, existing seed also HTTP)

    **Settings seeds** — only claude and opencode have canonical settings files:
    - `seeds/claude/settings.json`: Claude settings JSON with a few keys that will be PRESERVED after merge — e.g., `{"env": {"SOME_OLD_VAR": "old-value"}, "customKey": "preserved"}`
    - `seeds/opencode/settings.jsonc`: OpenCode settings JSONC with a few keys — e.g., `// OpenCode settings\n{"model": "some-old-model", "customKey": "preserved"}`

    Keep seeds minimal but representative (5-15 lines each). They must be valid parseable files.

    2. Extend `test/generate-golden.ts` to add MCP + settings rendering sections:

    **MCP section** (after Skills section):
    - Read all canonical MCP servers from `test/fixtures/canonical/mcp/*.json` (same pattern as readCanonicalMCPServers in canonical.ts — parse JSON, set name from filename)
    - For each adapter: read the corresponding seed file as `existingContent`, call `adapter.renderMCPServers(servers, existingContent)`, write output to `test/fixtures/{target}/mcp/{target-filename}`:
      - Claude: `test/fixtures/claude/mcp/settings.json` (Claude MCP merges into claude_desktop_config.json / settings file)
      - OpenCode: `test/fixtures/opencode/mcp/opencode.jsonc`
      - Gemini: `test/fixtures/gemini/mcp/settings.json`
      - Codex: `test/fixtures/codex/mcp/mcp_servers.toml`
    - Note: Codex renderMCPServers filters to HTTP-only servers (tavily is stdio, so only context7 renders for Codex)

    **Settings section** (after MCP section):
    - Only claude and opencode have canonical settings (gemini/codex have no settings file)
    - For each target with settings: create CanonicalSettings object `{ target, keys: JSON.parse(settingsRaw) }`, read seed as existingContent, call `adapter.renderSettings(settings, existingContent)`, write to `test/fixtures/{target}/settings/{filename}`
      - Claude: `test/fixtures/claude/settings/settings.json`
      - OpenCode: `test/fixtures/opencode/settings/opencode.json`

    3. Run `bun test/generate-golden.ts` to generate the new golden files.
    4. Verify golden files are created and contain merged content (seed servers + canonical servers both present in MCP goldens; seed keys + canonical keys both present in settings goldens).
  </action>
  <verify>
    - `bun test/generate-golden.ts` runs without error and reports increased file count
    - `ls test/fixtures/seeds/` shows claude, opencode, gemini, codex subdirs
    - `ls test/fixtures/claude/mcp/` shows settings.json
    - `ls test/fixtures/opencode/mcp/` shows opencode.jsonc
    - `ls test/fixtures/gemini/mcp/` shows settings.json
    - `ls test/fixtures/codex/mcp/` shows file exists
    - `ls test/fixtures/claude/settings/` shows settings.json
    - `ls test/fixtures/opencode/settings/` shows opencode.json
    - Golden MCP files contain both "existing-server" (from seed) and canonical servers (context7/tavily)
    - `bun test` passes (439+ tests, 0 fail)
  </verify>
  <done>
    Seed fixtures exist for all MCP targets and both settings targets. Golden generation script produces correct merged output for MCP and settings. All existing tests still pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove superseded push tests from orchestrator.test.ts</name>
  <files>
    src/cli/__tests__/orchestrator.test.ts
  </files>
  <action>
    Delete the entire `describe('runPush', ...)` block from `orchestrator.test.ts` (lines 167-280). The new E2E push tests in Plans 02/03 completely supersede this coverage (commands→claude-only push, dry-run, manifest creation, no-drift-after-push, pretty/JSON output).

    Keep the `describe('runCheck', ...)` block (lines 42-165) — those check tests are NOT being replaced.

    Also keep the imports, `setupProject`, and `makeSalt` helper — they're used by the runCheck tests.

    Remove the now-unused `homedir` import from `node:os` and `unlink` from `node:fs/promises` (only used by the push afterEach cleanup). Keep `mkdtemp`, `writeFile`, `mkdir` (used by runCheck tests).
  </action>
  <verify>
    - `orchestrator.test.ts` contains only `runCheck` describe block
    - No `runPush` import or usage remains
    - No `homedir` or `unlink` imports remain
    - `bun test src/cli/__tests__/orchestrator.test.ts` passes (check tests still green)
    - `bun test` passes with reduced test count (was 439, now ~430 since ~9 push tests removed)
  </verify>
  <done>
    orchestrator.test.ts contains only runCheck tests. Push test coverage will be provided by new E2E test files in Plans 02/03.
  </done>
</task>

</tasks>

<verification>
- `bun test/generate-golden.ts` succeeds and generates MCP + settings golden files
- All golden files contain merged content (seed + canonical)
- `bun test` passes with 0 failures
- `orchestrator.test.ts` only has runCheck tests
</verification>

<success_criteria>
- Seed fixtures committed in test/fixtures/seeds/
- MCP golden files exist for all 4 targets
- Settings golden files exist for claude and opencode
- generate-golden.ts produces all golden files in one run
- All tests pass (0 failures)
</success_criteria>

<output>
After completion, create `.planning/phases/11-push-e2e-tests/11-01-SUMMARY.md`
</output>
