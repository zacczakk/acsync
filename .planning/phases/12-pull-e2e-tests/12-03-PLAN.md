---
phase: 12-pull-e2e-tests
plan: 03
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - test/__tests__/pull-mcp.test.ts
  - test/__tests__/pull-settings.test.ts
  - test/__tests__/pull-instructions.test.ts
autonomous: true
requirements: [PULL-04, PULL-05, PULL-06, PULL-07]

must_haves:
  truths:
    - "Pulling MCP from all 4 targets produces canonical JSON matching original MCP fixtures"
    - "Pulling settings from claude + opencode produces canonical JSON matching original settings fixtures"
    - "Pulling instructions from all 4 targets produces canonical AGENTS.md matching original instructions fixture"
    - "Force pull overwrites existing canonical MCP/settings/instructions items"
  artifacts:
    - path: "test/__tests__/pull-mcp.test.ts"
      provides: "E2E pull tests for MCP servers across 4 targets"
      min_lines: 50
    - path: "test/__tests__/pull-settings.test.ts"
      provides: "E2E pull tests for settings (claude + opencode)"
      min_lines: 40
    - path: "test/__tests__/pull-instructions.test.ts"
      provides: "E2E pull tests for instructions across 4 targets"
      min_lines: 40
  key_links:
    - from: "test/__tests__/pull-mcp.test.ts"
      to: "src/cli/pull.ts"
      via: "import { runPull }"
      pattern: "import.*runPull.*from"
    - from: "test/__tests__/pull-mcp.test.ts"
      to: "test/fixtures/canonical/mcp/"
      via: "golden comparison for MCP JSON"
      pattern: "canonical.*mcp"
---

<objective>
E2E pull tests for MCP, settings, and instructions — 12+ test cells covering the remaining config types plus comprehensive PULL-07 overwrite verification.

Purpose: Complete the 24-cell pull test matrix. MCP exercises the new parseMCPServers adapter methods (from Plan 01). Settings exercises extractSettingsKeys reverse path. Instructions exercises identity passthrough.
Output: 3 test files completing all 24 pull cells.
</objective>

<execution_context>
@/Users/m332023/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/m332023/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-pull-e2e-tests/12-01-SUMMARY.md
@src/cli/pull.ts
@test/__tests__/push-mcp.test.ts
@test/__tests__/push-settings.test.ts
@test/__tests__/push-instructions.test.ts
@test/helpers/backup.ts
@test/fixtures/canonical/mcp/tavily.json
@test/fixtures/canonical/mcp/context7.json
@test/fixtures/canonical/settings/claude.json
@test/fixtures/canonical/settings/opencode.json
@test/fixtures/canonical/instructions/AGENTS.md
@src/adapters/path-resolver.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write pull-mcp.test.ts and pull-settings.test.ts E2E tests</name>
  <files>
    test/__tests__/pull-mcp.test.ts
    test/__tests__/pull-settings.test.ts
  </files>
  <action>
**pull-mcp.test.ts** — tests that pulling MCP config from targets produces canonical MCP JSON:

The approach: push canonical MCP fixtures to all 4 targets first (using `runPush`), then pull from each target into a fresh projectDir, verify the pulled MCP JSON matches canonical.

Alternatively (simpler): manually plant the MCP golden fixture files into target config paths, then pull. Use the push golden fixtures as the planted files since they represent what targets look like after a push.

**Setup:**
- `FIXTURE_ROOT`, `E2E_TIMEOUT = 60_000`, imports from `test/helpers/backup.ts`
- Import `runPull` from `src/cli/pull.ts`
- Import `createAdapter` from `src/cli/canonical.ts`

1. `plantMCPTargets()`: For each target, copy the push MCP golden file into the real target MCP config path:
   - Claude: `test/fixtures/claude/mcp/settings.json` → `~/.claude.json` (BUT this is the same as settings path — it's a shared file. Need to be careful not to clobber settings.)
   
   Actually, the safer approach: use `runPush` to push canonical MCP fixtures to targets, then pull back. This ensures target files are in the correct format.
   
   **Revised strategy**: 
   - `setupProjectDir()` with canonical fixtures (same as push tests)
   - `runPush({ projectDir, force: true, types: ['mcp'] })` to push MCP to targets
   - Create a FRESH projectDir2 (empty configs/)
   - `runPull({ source: target, force: true, projectDir: projectDir2 })` to pull MCP back
   - Compare pulled MCP files to canonical fixtures

2. **Test: "round-trip: push then pull MCP matches canonical"**:
   - All wrapped in `withTargetBackup`
   - Setup projectDir with canonical fixtures, push MCP
   - For each of 4 targets:
     - Create fresh empty projectDir
     - Pull from target with force
     - Read pulled `configs/mcp/tavily.json` (or whatever servers were pulled) and `configs/mcp/context7.json`
     - Parse JSON, compare key fields (description, transport, command/url, args) to canonical
     - Note: Codex only supports HTTP transport, so only `context7.json` should be pulled from codex (tavily is stdio, filtered out)
   
3. **Test: "non-force pull skips existing MCP files"**:
   - Push MCP to targets first
   - Pre-populate projectDir2 with sentinel `configs/mcp/tavily.json`
   - Pull without force
   - Verify sentinel preserved

**pull-settings.test.ts** — tests that pulling settings from targets produces canonical settings JSON:

Settings pull is tricky: it extracts *managed keys* from the installed settings file and writes them to `configs/settings/{target}.json`. The canonical settings files define which keys are managed.

**Strategy**: Push settings to targets (using seeds for merge behavior), then pull from a fresh projectDir that has the same canonical settings files (so `readCanonicalSettings` knows which keys to extract).

1. `setupProjectDir()`: Copy canonical fixtures into temp dir (including `configs/settings/` with claude.json and opencode.json).

2. **Test: "round-trip: push then pull settings matches canonical"**:
   - Wrapped in `withTargetBackup`
   - Push settings to claude + opencode (using seeds from `test/fixtures/seeds/`)
   - Create projectDir2 with canonical settings structure (so pull knows which keys to manage)
   - Pull settings from claude → check `configs/settings/claude.json` matches canonical
   - Pull settings from opencode → check `configs/settings/opencode.json` matches canonical
   - Gemini/Codex: `caps.settings` is false, pull should produce no settings items for these targets

3. **Test: "gemini and codex have no settings capability"**:
   - Verify `createAdapter('gemini').getCapabilities().settings === false`
   - Verify `createAdapter('codex').getCapabilities().settings === false`
  </action>
  <verify>
    `bun test test/__tests__/pull-mcp.test.ts test/__tests__/pull-settings.test.ts` passes.
    Both files exist with at least 2 test cases each.
  </verify>
  <done>
    Pull MCP from all 4 targets verified via round-trip (PULL-05).
    Pull settings from claude + opencode verified via round-trip (PULL-04).
    Gemini/Codex settings-disabled verified.
    Force overwrite for MCP verified (PULL-07 partial).
  </done>
</task>

<task type="auto">
  <name>Task 2: Write pull-instructions.test.ts E2E test</name>
  <files>test/__tests__/pull-instructions.test.ts</files>
  <action>
**pull-instructions.test.ts** — instructions are identity passthrough (same content to/from all targets):

**Setup:**
- Standard imports: `runPull`, `withTargetBackup`, fixtures
- Import `createAdapter` for path resolution

**Strategy**: Push instructions to all 4 targets, then pull from each target into fresh projectDir, verify content matches canonical AGENTS.md.

1. `setupProjectDir()`: Copy canonical fixtures to temp dir.

2. `plantInstructions()`: Push canonical instructions to targets:
   - Use `runPush({ projectDir, force: true, types: ['instruction'] })` to push
   - Or manually copy: `test/fixtures/{target}/instructions/{filename}` to the target instructions path
   - Claude: `test/fixtures/claude/instructions/CLAUDE.md` → `~/.claude/CLAUDE.md`
   - OpenCode: `test/fixtures/opencode/instructions/AGENTS.md` → `~/.config/opencode/AGENTS.md`
   - Gemini: `test/fixtures/gemini/instructions/AGENTS.md` → `~/.gemini/AGENTS.md`
   - Codex: `test/fixtures/codex/instructions/AGENTS.md` → `~/.codex/AGENTS.md`

3. **Test: "round-trip: push then pull instructions matches canonical"**:
   - Wrapped in `withTargetBackup`
   - Push instructions to all 4 targets
   - For each target:
     - Create fresh projectDir
     - `runPull({ source: target, force: true, projectDir })`
     - Read `configs/instructions/AGENTS.md` from projectDir
     - Compare to canonical `test/fixtures/canonical/instructions/AGENTS.md`
   - Since instructions are identity passthrough, all 4 targets should produce identical output matching canonical

4. **Test: "force pull overwrites existing canonical instructions"** (PULL-07):
   - Push instructions to claude target
   - Pre-populate projectDir with sentinel `configs/instructions/AGENTS.md` (write "sentinel content")
   - Pull with `force: true` from claude
   - Verify AGENTS.md content now matches canonical (overwritten)
   - Pull without force from opencode into same projectDir
   - Verify content was NOT overwritten (skipped since file exists)
  </action>
  <verify>
    `bun test test/__tests__/pull-instructions.test.ts` passes.
    At least 2 test cases: round-trip golden comparison + force overwrite.
  </verify>
  <done>
    Pull instructions from all 4 targets verified (PULL-06).
    Force overwrite for instructions verified (PULL-07).
    All 24 pull cells now covered across Plans 02 and 03.
  </done>
</task>

</tasks>

<verification>
- `bun test test/__tests__/pull-mcp.test.ts test/__tests__/pull-settings.test.ts test/__tests__/pull-instructions.test.ts` — all pass
- `bun test` full suite — zero regressions
- All 24 pull cells covered: 6 types × 4 targets (with gemini/codex settings being "disabled" assertions)
</verification>

<success_criteria>
- Pull MCP from 4 targets verified via round-trip golden comparison (PULL-05)
- Pull settings from claude + opencode verified; gemini/codex disabled confirmed (PULL-04)
- Pull instructions from 4 targets verified (PULL-06)
- Force pull overwrites existing canonical items (PULL-07 complete)
- All 3 test files exist and pass
- Combined with Plan 02: all 24 pull cells covered
</success_criteria>

<output>
After completion, create `.planning/phases/12-pull-e2e-tests/12-03-SUMMARY.md`
</output>
