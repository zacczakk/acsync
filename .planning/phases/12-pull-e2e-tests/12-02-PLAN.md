---
phase: 12-pull-e2e-tests
plan: 02
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - test/__tests__/pull-commands.test.ts
  - test/__tests__/pull-agents.test.ts
  - test/__tests__/pull-skills.test.ts
autonomous: true
requirements: [PULL-01, PULL-02, PULL-03, PULL-07]

must_haves:
  truths:
    - "Pulling commands from all 4 targets produces canonical frontmatter markdown matching canonical fixtures"
    - "Pulling agents from all 4 targets produces canonical frontmatter markdown matching canonical fixtures"
    - "Pulling skills from all 4 targets produces canonical frontmatter markdown matching canonical fixtures"
    - "Force pull overwrites pre-existing canonical items"
    - "Non-force pull skips items that already exist in canonical"
  artifacts:
    - path: "test/__tests__/pull-commands.test.ts"
      provides: "E2E pull tests for commands across 4 targets"
      min_lines: 60
    - path: "test/__tests__/pull-agents.test.ts"
      provides: "E2E pull tests for agents across 4 targets"
      min_lines: 60
    - path: "test/__tests__/pull-skills.test.ts"
      provides: "E2E pull tests for skills across 4 targets"
      min_lines: 40
  key_links:
    - from: "test/__tests__/pull-commands.test.ts"
      to: "src/cli/pull.ts"
      via: "import { runPull }"
      pattern: "import.*runPull.*from"
    - from: "test/__tests__/pull-commands.test.ts"
      to: "test/fixtures/canonical/"
      via: "golden comparison readFileSync"
      pattern: "FIXTURE_ROOT.*canonical"
---

<objective>
E2E pull tests for commands, agents, and skills — 12 test cells (3 types × 4 targets) plus force-overwrite verification for PULL-07.

Purpose: Verify that pulling target-format files back through adapter reverse-parsers produces correct canonical format. Uses the push golden fixtures as pull input and canonical fixtures as expected output.
Output: 3 test files covering 12 pull cells + skip/force behavior.
</objective>

<execution_context>
@/Users/m332023/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/m332023/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-pull-e2e-tests/12-01-SUMMARY.md
@src/cli/pull.ts
@test/__tests__/push-commands.test.ts
@test/__tests__/push-agents.test.ts
@test/__tests__/push-skills.test.ts
@test/helpers/backup.ts
@src/adapters/path-resolver.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write pull-commands.test.ts E2E test</name>
  <files>test/__tests__/pull-commands.test.ts</files>
  <action>
Create `test/__tests__/pull-commands.test.ts` following the push test pattern in reverse:

**Pattern: Plant target-format files → pull → compare canonical output to canonical fixtures**

```
const E2E_TIMEOUT = 60_000;
const FIXTURE_ROOT = join(import.meta.dir, '../fixtures');
```

**Setup helpers:**

1. `setupProjectDir()`: Create a temp dir with empty `configs/` structure (no canonical commands pre-populated). Return the temp dir path.

2. `plantTargetCommands()`: For each target, copy the push golden fixture files into the real target command directories:
   - Claude: copy `test/fixtures/claude/commands/*.md` → `~/.claude/commands/`
   - OpenCode: copy `test/fixtures/opencode/commands/*.md` → `~/.config/opencode/command/`
   - Gemini: copy `test/fixtures/gemini/commands/*.toml` → `~/.gemini/commands/`
   - Codex: copy `test/fixtures/codex/commands/*.md` → `~/.codex/prompts/`
   
   Use `cpSync` after ensuring target dirs exist with `mkdirSync({ recursive: true })`.
   Also clear any existing non-fixture command files from those dirs first (rm + recreate) to ensure a clean target state.

**Tests (all wrapped in `withTargetBackup`):**

1. **"pulls commands from all 4 targets matching canonical fixtures"**:
   - Plant target commands
   - For each of the 4 targets:
     - `runPull({ source: target, force: true, projectDir, types: ['command'] })` — wait, `runPull` doesn't have `types` option. Just call `runPull({ source: target, force: true, projectDir })` and it pulls everything. That's fine — commands will be among the pulled items.
   - After pulling from claude (first target since it's identity passthrough and most reliable):
     - Read `configs/commands/groom-docs.md` from projectDir
     - Compare to `test/fixtures/canonical/commands/groom-docs.md`
     - Read `configs/commands/obs-jot.md` from projectDir
     - Compare to `test/fixtures/canonical/commands/obs-jot.md`
   - Note: Claude is identity passthrough for commands, so this should match exactly. For other targets (Gemini TOML, Codex flat md), the reverse-parser reconstructs canonical format — but metadata may differ slightly (e.g., Gemini strips allowed-tools on push, so pull can't recover them). Test by pulling from each target individually into separate temp dirs and checking that at minimum `description` frontmatter key and body content match.
   - For Gemini: Pull from gemini into fresh projectDir. Verify pulled `groom-docs.md` has `description` in frontmatter and body content matches canonical body.
   - For Codex: Pull from codex into fresh projectDir. Verify pulled `groom-docs.md` has `description` in frontmatter and body content matches canonical body.
   
   Actually — the simplest approach: since the test fixtures were generated by rendering canonical through each adapter, pulling them back should produce output close to canonical. But some adapters strip metadata on push (OpenCode strips allowed-tools/argument-hint for commands, Gemini strips them too). So pulled commands from non-Claude targets may have fewer frontmatter keys.
   
   **Test strategy**: Pull from Claude → exact match to canonical. Pull from other targets → verify structure (has frontmatter, has description, body content matches).

2. **"non-force pull skips existing canonical commands"**:
   - Pre-populate projectDir with `configs/commands/groom-docs.md` (write a sentinel content like "existing")
   - Plant target commands
   - `runPull({ source: 'claude-code', projectDir })` (no force)
   - Verify groom-docs.md still has sentinel content (was skipped)
   - Verify result.items has groom-docs with `action: 'skip'`

3. **"force pull overwrites existing canonical commands"** (PULL-07):
   - Pre-populate projectDir with `configs/commands/groom-docs.md` (sentinel)
   - Plant target commands
   - `runPull({ source: 'claude-code', force: true, projectDir })`
   - Verify groom-docs.md content now matches canonical fixture (was overwritten)
  </action>
  <verify>
    `bun test test/__tests__/pull-commands.test.ts` passes.
    Verify: at least 3 test cases exist (golden, skip, force overwrite).
  </verify>
  <done>
    Pull commands from all 4 targets verified with golden comparison (PULL-01).
    Force overwrite behavior verified (PULL-07 partial).
    Non-force skip behavior verified.
  </done>
</task>

<task type="auto">
  <name>Task 2: Write pull-agents.test.ts and pull-skills.test.ts E2E tests</name>
  <files>
    test/__tests__/pull-agents.test.ts
    test/__tests__/pull-skills.test.ts
  </files>
  <action>
**pull-agents.test.ts** — same pattern as pull-commands but for agents:

1. `plantTargetAgents()`: Copy push golden agent files into real target dirs:
   - Claude: `test/fixtures/claude/agents/*.md` → `~/.claude/agents/`
   - OpenCode: `test/fixtures/opencode/agents/*.md` → `~/.config/opencode/agents/`
   - Gemini: `test/fixtures/gemini/agents/*.md` → `~/.gemini/agents/`
   - Codex: `test/fixtures/codex/agents/agent-*.md` → `~/.codex/prompts/` (note: codex agents are `agent-` prefixed and go to prompts/)
   
   Clear existing non-fixture agent files first.

2. Tests (all in withTargetBackup):
   - **"pulls agents from all 4 targets matching canonical fixtures"**: Pull from Claude → exact match to canonical `test-agent.md` and `simple-agent.md`. Pull from Codex → verify `parseAgent` correctly strips `agent-` prefix and reconstructs frontmatter with name, description, allowed-tools.
   - **"force pull overwrites existing canonical agents"** (PULL-07 partial): Pre-populate, force pull, verify overwrite.

**pull-skills.test.ts** — skills only exist for targets with `caps.skills`:

1. `plantTargetSkills()`: Copy push golden skill files:
   - Claude: `test/fixtures/claude/skills/{name}/SKILL.md` → `~/.claude/skills/{name}/SKILL.md`
   - OpenCode: `test/fixtures/opencode/skills/{name}/SKILL.md` → `~/.config/opencode/skill/{name}/SKILL.md` (note: opencode uses `skill/` singular)
   - Gemini: skills dir at `~/.gemini/skills/{name}/SKILL.md`
   - Codex: skills dir at `~/.codex/skills/{name}/SKILL.md`

2. Tests (all in withTargetBackup):
   - **"pulls skills from claude matching canonical fixtures"**: Pull from Claude → compare obsidian/SKILL.md and web-design-guidelines/SKILL.md to canonical fixtures.
   - **"pulls skills from opencode"**: Pull from opencode, verify skill content.
   - Note: Skills are identity passthrough (no format transformation), so all adapters produce identical output. Test at least 2 targets.

For both files: use `E2E_TIMEOUT = 60_000`, `FIXTURE_ROOT`, `withTargetBackup` from `test/helpers/backup.ts`, `runPull` from `src/cli/pull.ts`.

When planting target files, ensure parent directories exist with `mkdirSync({ recursive: true })`. When clearing directories, use `rmSync({ recursive: true, force: true })` on specific subdirectories (commands dir, agents dir, skills dir) — do NOT rm the entire target base dir.
  </action>
  <verify>
    `bun test test/__tests__/pull-agents.test.ts test/__tests__/pull-skills.test.ts` passes.
    Both files exist and have at least 2 test cases each.
  </verify>
  <done>
    Pull agents from all 4 targets verified with golden comparison (PULL-02).
    Pull skills from targets verified with golden comparison (PULL-03).
    Force overwrite verified for agents (PULL-07 partial).
  </done>
</task>

</tasks>

<verification>
- `bun test test/__tests__/pull-commands.test.ts test/__tests__/pull-agents.test.ts test/__tests__/pull-skills.test.ts` — all pass
- At minimum 8 test assertions covering PULL-01, PULL-02, PULL-03, PULL-07
- `bun test` full suite still passes
</verification>

<success_criteria>
- Pull commands from 4 targets verified against canonical fixtures (PULL-01)
- Pull agents from 4 targets verified against canonical fixtures (PULL-02)
- Pull skills from 2+ targets verified against canonical fixtures (PULL-03)
- Force pull overwrites existing canonical items (PULL-07 partially covered)
- All 3 test files exist and pass
</success_criteria>

<output>
After completion, create `.planning/phases/12-pull-e2e-tests/12-02-SUMMARY.md`
</output>
