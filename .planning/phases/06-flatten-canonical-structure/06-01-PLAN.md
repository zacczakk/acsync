---
phase: 06-flatten-canonical-structure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - configs/agents/
  - configs/commands/
  - configs/mcp/
  - configs/settings/
  - configs/skills/
  - configs/instructions/
  - src/cli/canonical.ts
  - src/cli/render.ts
  - src/cli/pull.ts
  - src/cli/check.ts
  - src/cli/index.ts
  - src/cli/__tests__/orchestrator.test.ts
  - src/cli/__tests__/stale-and-pull.test.ts
  - AGENTS.md
  - configs/common/instructions/claude.md
  - configs/common/instructions/opencode.md
  - MCPORTER_ANALYSIS.md
  - SYNC.md
autonomous: true
requirements:
  - STRUCT-01
  - STRUCT-02
  - STRUCT-03
  - STRUCT-04
  - STRUCT-05

must_haves:
  truths:
    - "configs/agents/, configs/commands/, configs/mcp/, configs/settings/, configs/skills/, configs/instructions/ exist directly under configs/"
    - "configs/common/ directory does not exist"
    - "acsync check runs successfully against the new path structure (no 'not found' errors)"
    - "All 414 tests pass with zero references to configs/common/ in source or test code"
    - "acsync --help output references configs/ (not configs/common/)"
  artifacts:
    - path: "src/cli/canonical.ts"
      provides: "Path constants (CANONICAL_ROOT + subdirectory constants) and all readCanonical* functions using them"
      contains: "CANONICAL_ROOT"
    - path: "src/cli/index.ts"
      provides: "Updated CLI description referencing configs/"
      contains: "configs/"
    - path: "src/cli/render.ts"
      provides: "Updated error messages referencing configs/"
    - path: "src/cli/pull.ts"
      provides: "Updated path references and doc strings"
    - path: "src/cli/check.ts"
      provides: "Updated sourcePath references"
  key_links:
    - from: "src/cli/canonical.ts"
      to: "configs/"
      via: "path constants CANONICAL_ROOT + join()"
      pattern: "CANONICAL_ROOT"
    - from: "src/cli/render.ts"
      to: "src/cli/canonical.ts"
      via: "import readSingleCanonicalItem"
      pattern: "CANONICAL_ROOT"
    - from: "src/cli/pull.ts"
      to: "src/cli/canonical.ts"
      via: "import path constants"
      pattern: "CANONICAL_ROOT"
    - from: "src/cli/check.ts"
      to: "src/cli/canonical.ts"
      via: "import path constants"
      pattern: "CANONICAL_ROOT"
---

<objective>
Flatten canonical config structure: move all subdirectories from `configs/common/` to `configs/`, update all path references in source code, tests, and docs. Single atomic commit per user decision.

Purpose: Remove unnecessary intermediate `common/` directory — simpler canonical path structure.
Output: All configs at `configs/`, all code/tests/docs updated, `configs/common/` deleted. One commit.
</objective>

<execution_context>
@/Users/m332023/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/m332023/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-flatten-canonical-structure/06-CONTEXT.md
@src/cli/canonical.ts
@src/cli/render.ts
@src/cli/pull.ts
@src/cli/check.ts
@src/cli/index.ts
@src/cli/__tests__/orchestrator.test.ts
@src/cli/__tests__/stale-and-pull.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Move files, add path constants, update all source/test/doc references</name>
  <files>
    configs/
    src/cli/canonical.ts
    src/cli/render.ts
    src/cli/pull.ts
    src/cli/check.ts
    src/cli/index.ts
    src/cli/__tests__/orchestrator.test.ts
    src/cli/__tests__/stale-and-pull.test.ts
    AGENTS.md
    configs/instructions/claude.md
    configs/instructions/opencode.md
    MCPORTER_ANALYSIS.md
    SYNC.md
  </files>
  <action>
  **Pre-flight:** Verify clean git working tree (`git status --porcelain` must be empty). If dirty, stop and warn.

  **Step 1: Physical file move.** Per user decision: plain `mv`, not `git mv`.
  ```bash
  mv configs/common/agents configs/agents
  mv configs/common/commands configs/commands
  mv configs/common/mcp configs/mcp
  mv configs/common/settings configs/settings
  mv configs/common/skills configs/skills
  mv configs/common/instructions configs/instructions
  rm -rf configs/common
  ```
  Verify: `ls configs/` shows agents/, commands/, instructions/, mcp/, settings/, skills/ and NO common/.

  **Step 2: Add path constants to `src/cli/canonical.ts`.**
  At the top of the file (after imports, before `SyncOptions`), add:
  ```typescript
  import { resolve } from 'node:path';

  /** Canonical config root — single source of truth for all config paths */
  const CANONICAL_ROOT = 'configs';

  /** Subdirectory constants — import these instead of string-concatenating paths */
  export const COMMANDS_DIR = join(CANONICAL_ROOT, 'commands');
  export const AGENTS_DIR = join(CANONICAL_ROOT, 'agents');
  export const MCP_DIR = join(CANONICAL_ROOT, 'mcp');
  export const INSTRUCTIONS_DIR = join(CANONICAL_ROOT, 'instructions');
  export const SKILLS_DIR = join(CANONICAL_ROOT, 'skills');
  export const SETTINGS_DIR = join(CANONICAL_ROOT, 'settings');
  ```
  These are relative from projectDir. All functions in canonical.ts already receive projectDir and `join(projectDir, ...)`. Replace all `join(projectDir, 'configs', 'common', 'commands')` patterns with `join(projectDir, COMMANDS_DIR)`, etc.

  Update every `readCanonical*` function in canonical.ts:
  - `readCanonicalCommands`: `join(projectDir, 'configs', 'common', 'commands')` → `join(projectDir, COMMANDS_DIR)`
  - `readCanonicalAgents`: `join(projectDir, 'configs', 'common', 'agents')` → `join(projectDir, AGENTS_DIR)`
  - `readCanonicalMCPServers`: `join(projectDir, 'configs', 'common', 'mcp')` → `join(projectDir, MCP_DIR)`
  - `readCanonicalInstructions`: `join(projectDir, 'configs', 'common', 'instructions', ...)` → `join(projectDir, INSTRUCTIONS_DIR, ...)`
  - `readCanonicalSkills`: `join(projectDir, 'configs', 'common', 'skills')` → `join(projectDir, SKILLS_DIR)`

  Also update doc comments: `configs/common/commands/*.md` → `configs/commands/*.md`, etc.

  **Step 3: Update `src/cli/render.ts`.**
  Import constants from canonical.ts where needed. Update:
  - Line 85: error message `configs/common/mcp/` → `configs/mcp/`
  - Line 101: error message `configs/common/skills/` → `configs/skills/`
  - `readSingleCanonicalItem` (line 134): `join(projectDir, 'configs', 'common', dirName, ...)` → `join(projectDir, CANONICAL_ROOT, dirName, ...)`
    OR better: import COMMANDS_DIR/AGENTS_DIR and use a lookup. Simplest: `join(projectDir, 'configs', dirName, ...)` (just drop 'common').

  **Step 4: Update `src/cli/pull.ts`.**
  Import constants from canonical.ts. Replace all 12 occurrences of `join(projectDir, 'configs', 'common', ...)`:
  - Lines 72, 79, 86 (discovery): use COMMANDS_DIR, AGENTS_DIR, SKILLS_DIR
  - Lines 106, 121, 138 (targetPath): use COMMANDS_DIR, AGENTS_DIR, SKILLS_DIR
  - Lines 174, 181, 186 (mkdir): use COMMANDS_DIR, AGENTS_DIR, SKILLS_DIR
  Update doc strings (lines 58, 367, 370): `configs/common/` → `configs/`

  **Step 5: Update `src/cli/check.ts`.**
  Import constants. Replace:
  - Line 142: `join(projectDir, 'configs', 'common', 'commands', ...)` → `join(projectDir, COMMANDS_DIR, ...)`
  - Line 163: `join(projectDir, 'configs', 'common', 'agents', ...)` → `join(projectDir, AGENTS_DIR, ...)`

  **Step 6: Update `src/cli/index.ts`.**
  Line 11: Change `Manages canonical configs in configs/common/` → `Manages canonical configs in configs/`

  **Step 7: Update tests.**
  In `src/cli/__tests__/orchestrator.test.ts` and `src/cli/__tests__/stale-and-pull.test.ts`:
  Replace all `join(dir/tmpDir, 'configs', 'common', ...)` with `join(dir/tmpDir, 'configs', ...)`.
  Per user decision: make test assertions path-agnostic where they check error messages — verify the error is thrown, not the exact path string. For directory construction in test setup, just update the path.

  Occurrences in orchestrator.test.ts (lines 11, 23, 32, 114): update path.
  Occurrences in stale-and-pull.test.ts (lines 24, 70, 114, 135, 143, 151, 178, 216): update path.

  **Step 8: Update docs.**
  - `AGENTS.md` line 168: `~/Repos/agents/configs/common/` → `~/Repos/agents/configs/`
  - `configs/instructions/claude.md` (now at new location) lines 5-6: `~/Repos/agents/configs/common/commands` → `~/Repos/agents/configs/commands`, same for agents
  - `configs/instructions/opencode.md` lines 5-6: same changes
  - `MCPORTER_ANALYSIS.md`: replace all `configs/common/mcp/` → `configs/mcp/` (lines 8, 145, 179)
  - `SYNC.md`: check for any `configs/common/` references and update

  **Step 9: Final grep verification.** Run `grep -r 'configs/common' src/ configs/ AGENTS.md SYNC.md MCPORTER_ANALYSIS.md` and confirm zero hits. Exclude `.planning/` and `node_modules/`.

  **Step 10: Single atomic commit.** Per user decision: ALL changes in one commit.
  ```bash
  committer "refactor(06-01): flatten configs/common/ to configs/" configs/ src/cli/canonical.ts src/cli/render.ts src/cli/pull.ts src/cli/check.ts src/cli/index.ts src/cli/__tests__/orchestrator.test.ts src/cli/__tests__/stale-and-pull.test.ts AGENTS.md MCPORTER_ANALYSIS.md SYNC.md
  ```
  Note: `committer` stages only listed paths. Since `configs/common/` is deleted, you need to also `git add -A configs/` to capture both deletions and additions before committing. Use `git add configs/ && committer ...` or stage manually.
  </action>
  <verify>
  1. `ls configs/` shows: agents/ commands/ instructions/ mcp/ settings/ skills/ (no common/)
  2. `ls configs/common 2>&1` returns error (directory gone)
  3. `grep -r 'configs/common' src/ --include='*.ts' | wc -l` returns 0
  4. `grep -r 'configs/common' src/ --include='*.test.ts' | wc -l` returns 0
  5. `bun test` — all 414 tests pass
  6. `bun run bin/acsync check --pretty 2>&1 | head -5` — no "not found" errors
  7. `bun run bin/acsync --help | grep 'configs/'` — shows `configs/` not `configs/common/`
  </verify>
  <done>
  - configs/ contains all 6 subdirectories directly (no common/ intermediate)
  - configs/common/ does not exist
  - All source code uses path constants from canonical.ts (COMMANDS_DIR, AGENTS_DIR, etc.)
  - All tests pass (0 failures)
  - acsync check runs without path errors
  - acsync --help shows configs/ in description
  - Zero grep hits for 'configs/common' in src/ and configs/
  - Single atomic commit with all changes
  </done>
</task>

</tasks>

<verification>
1. Directory structure: `configs/` has agents/, commands/, instructions/, mcp/, settings/, skills/ — no common/
2. `grep -rn 'configs/common' src/ configs/ AGENTS.md SYNC.md MCPORTER_ANALYSIS.md` returns nothing
3. `bun test` passes all tests
4. `bun run bin/acsync check` succeeds (exit 0 or 2, not 1)
5. `bun run bin/acsync --help` shows `configs/` in description
6. `git log -1 --oneline` shows single atomic commit
</verification>

<success_criteria>
- STRUCT-01: configs/ contains all 6 subdirectories directly
- STRUCT-02: All source code path references use configs/ (verified by grep)
- STRUCT-03: All test fixtures use configs/ paths, all 414 tests pass
- STRUCT-04: CLI help text and error messages reference configs/
- STRUCT-05: configs/common/ does not exist
</success_criteria>

<output>
After completion, create `.planning/phases/06-flatten-canonical-structure/06-01-SUMMARY.md`
</output>
