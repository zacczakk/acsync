---
phase: 04-cli-subcommands-test-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/cli/index.ts
  - src/cli/render.ts
  - src/cli/diff.ts
  - src/cli/check.ts
  - src/cli/push.ts
  - src/cli/orchestrator.ts
  - src/cli/__tests__/render.test.ts
  - src/cli/__tests__/diff.test.ts
autonomous: true
requirements:
  - CLI-01
  - CLI-02
  - CLI-05

must_haves:
  truths:
    - "acsync render --type command --name plan --target claude outputs rendered content to stdout"
    - "acsync render without --target outputs all 4 target renderings"
    - "acsync diff shows unified diff (line-level) between rendered canonical and on-disk target files"
    - "acsync diff exits 0 when no drift, exit 2 when drift detected"
    - "acsync check --json produces JSON output (same as default behavior)"
    - "acsync push --json produces JSON output (same as default behavior)"
  artifacts:
    - path: "src/cli/render.ts"
      provides: "render subcommand registration"
      exports: ["renderCommand"]
    - path: "src/cli/diff.ts"
      provides: "diff subcommand registration"
      exports: ["diffCommand"]
    - path: "src/cli/index.ts"
      provides: "CLI with render + diff subcommands registered"
  key_links:
    - from: "src/cli/render.ts"
      to: "src/cli/orchestrator.ts"
      via: "imports adapter creation + canonical reading functions"
      pattern: "createAdapter|readCanonical"
    - from: "src/cli/diff.ts"
      to: "src/cli/orchestrator.ts"
      via: "imports runCheck for diff computation"
      pattern: "runCheck"
    - from: "src/cli/index.ts"
      to: "src/cli/render.ts"
      via: "program.addCommand(renderCommand)"
      pattern: "addCommand.*renderCommand"
---

<objective>
Add `render` and `diff` subcommands to acsync CLI, plus `--json` flag on check/push.

Purpose: Satisfy CLI-01 (render), CLI-02 (diff), CLI-05 (--json) requirements. These are the last 3 unfinished v1 CLI requirements.
Output: Two new CLI subcommands + --json flag on existing subcommands, with tests.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Key source files:
@src/cli/index.ts
@src/cli/check.ts
@src/cli/push.ts
@src/cli/cli-helpers.ts
@src/cli/orchestrator.ts
@src/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add render subcommand</name>
  <files>src/cli/render.ts, src/cli/index.ts, src/cli/__tests__/render.test.ts</files>
  <action>
Create `src/cli/render.ts` with a Commander subcommand `renderCommand`:

**Interface (per user decision):**
- `acsync render --type <command|agent|mcp|instruction|skill> --name <name> [--target <claude|gemini|codex|opencode>]`
- `--type` is required — uses same validation as existing `validateTypes` but accepts SINGULAR forms (command, agent, mcp, instruction, skill)
- `--name` is required — the canonical item name (e.g., `plan`, `gate`, `tavily`)
- `--target` is optional — if omitted, render all 4 targets

**Output (per user decision):**
- Raw rendered config content to stdout (no JSON wrapping)
- Multi-target output: print each target's rendering separated by a header line like `--- claude ---\n{content}\n` (Claude's discretion per CONTEXT.md)

**Implementation approach:**
1. Import `createAdapter` helper. NOTE: `createAdapter` is currently a module-private function in orchestrator.ts. Export it from orchestrator.ts so render.ts can use it.
2. Read the canonical item: for commands use `readCanonicalCommands`, for agents use `readCanonicalAgents`, etc. These are also module-private in orchestrator.ts — export the ones needed, OR implement a simpler approach: read the single file directly since we know --name and --type:
   - command: `configs/common/commands/{name}.md` → parseFrontmatter → CanonicalItem
   - agent: `configs/common/agents/{name}.md` → parseFrontmatter → CanonicalItem
   - mcp: `configs/common/mcp/{name}.json` → readJson → MCPServer
   - instruction: special case (AGENTS.md + addendum) — render via adapter.renderInstructions()
   - skill: `configs/common/skills/{name}/SKILL.md` → parseFrontmatter + readSupportFiles
3. For each target (or filtered target), call the adapter's render method
4. Write rendered content to stdout

**Error handling:**
- File not found → stderr: `Error: canonical {type} "{name}" not found at {path}`
- Invalid type/target → stderr with valid options (reuse existing validation helpers)

**In `src/cli/index.ts`:** Import and `program.addCommand(renderCommand)`.

**Tests in `src/cli/__tests__/render.test.ts`:**
- Test that render reads a real canonical command (e.g., `zz-gate`) and outputs non-empty content for each target
- Test that --target filters to single target
- Test error on nonexistent item name
  </action>
  <verify>
`bun test src/cli/__tests__/render.test.ts` passes. Manual: `bun src/cli/index.ts render --type command --name zz-gate --target claude` outputs rendered markdown to stdout.
  </verify>
  <done>
`acsync render --type command --name zz-gate` outputs rendered content for all 4 targets. `--target claude` filters to Claude only. Nonexistent names produce clear error.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add diff subcommand and --json flag</name>
  <files>src/cli/diff.ts, src/cli/index.ts, src/cli/check.ts, src/cli/push.ts, src/cli/__tests__/diff.test.ts</files>
  <action>
**diff subcommand — `src/cli/diff.ts`:**

Per user decision: `diff` is DISTINCT from `check`. Shows unified diff format (like `git diff`) with actual line-level changes.

Create `diffCommand`:
- Same flags as check: `--target`, `--type` (reuse `collect`, `mapTargets`, `mapTypes`, `validateTargets`, `validateTypes`)
- NO `--pretty` or `--json` flags (per user decision: diff always outputs text)
- Exit codes: 0=no drift, 1=error, 2=drift detected (same as check)

**Implementation:**
1. Call `runCheck()` with same options to get `OrchestratorCheckResult` containing `diffs: DiffResult[]`
2. For each DiffResult target, for each operation that is create/update (not skip):
   - Read the canonical source, render it via adapter
   - Read the current on-disk target file (if exists)
   - Compute unified diff between on-disk content and rendered content
   - Use a simple unified diff implementation: split both strings by newline, walk lines, output `---`/`+++` header, then `@@` hunks with context lines (3 lines default). OR use the `diff` npm package if available — check `package.json` first. If not available, implement a minimal line-diff: show `- old line` / `+ new line` format without full hunk computation (simpler, sufficient for v1).
3. For `create` operations (no on-disk file): show all lines as `+` additions
4. Output to stdout

**Register in `src/cli/index.ts`:** `program.addCommand(diffCommand)`.

**--json flag — update `src/cli/check.ts` and `src/cli/push.ts`:**

Per user decision: `--json` is meaningful only for check and push. JSON is already the default output. `--json` makes this explicit for scripts.

- Add `.option('--json', 'Output JSON (default behavior, explicit for scripts)')` to both `checkCommand` and `pushCommand`
- Behavior: no-op (JSON is already default). The flag exists to self-document that the output is machine-parseable. Do NOT change any existing output behavior.
- When `--pretty` and `--json` are both passed, `--pretty` wins (pretty is the explicit override).

**Tests in `src/cli/__tests__/diff.test.ts`:**
- Test diff output contains `---` and `+++` headers
- Test diff exits with 0 when no drift
- Test diff produces unified diff lines for known changes
  </action>
  <verify>
`bun test src/cli/__tests__/diff.test.ts` passes. Manual: `bun src/cli/index.ts diff --target claude --type commands` shows line-level diffs. `bun src/cli/index.ts check --json` still works (no regression).
  </verify>
  <done>
`acsync diff` shows unified diff output for all targets. `--target` and `--type` filters work. `--json` flag accepted on check and push commands without behavior change. All existing tests still pass.
  </done>
</task>

</tasks>

<verification>
- `bun test` passes (0 new failures introduced)
- `bun src/cli/index.ts render --help` shows render subcommand help
- `bun src/cli/index.ts diff --help` shows diff subcommand help
- `bun src/cli/index.ts check --json` works (flag accepted)
- `bun src/cli/index.ts push --json --dry-run --force` works (flag accepted)
</verification>

<success_criteria>
- render subcommand renders canonical configs to stdout in target format (CLI-01)
- diff subcommand shows unified text diff between rendered and on-disk (CLI-02)
- --json flag accepted on check and push (CLI-05)
- No regressions in existing 431 passing tests
</success_criteria>

<output>
After completion, create `.planning/phases/04-cli-subcommands-test-fixes/04-01-SUMMARY.md`
</output>
