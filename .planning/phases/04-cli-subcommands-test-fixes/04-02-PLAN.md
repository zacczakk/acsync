---
phase: 04-cli-subcommands-test-fixes
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/core/rollback.ts
  - src/core/__tests__/rollback.test.ts
  - src/adapters/__tests__/skills.test.ts
autonomous: true
requirements:
  - CLI-01
  - CLI-02
  - CLI-05
gap_closure: true

must_haves:
  truths:
    - "createBackup produces unique backup filenames even when called twice in same millisecond"
    - "rollback.test.ts 'processes backups in reverse order' test passes reliably"
    - "skills.test.ts passes without depending on specific skills installed on host machine"
    - "All 435 tests pass with 0 failures"
  artifacts:
    - path: "src/core/rollback.ts"
      provides: "Collision-safe backup filename generation"
      contains: "counter|performance.now|hrtime"
    - path: "src/adapters/__tests__/skills.test.ts"
      provides: "Host-independent skill tests using temp directory fixtures"
      contains: "mkdtemp|tmpdir"
  key_links:
    - from: "src/core/__tests__/rollback.test.ts"
      to: "src/core/rollback.ts"
      via: "createBackup import"
      pattern: "createBackup"
    - from: "src/adapters/__tests__/skills.test.ts"
      to: "src/adapters/claude-code.ts"
      via: "ClaudeCodeAdapter import"
      pattern: "ClaudeCodeAdapter"
---

<objective>
Fix 4 test failures: Date.now() collision in rollback createBackup, and skills.test.ts host environment dependency.

Purpose: All tests must pass (0 failures). Current state: 431 pass, 4 fail.
Output: Fixed rollback.ts + rewritten skills.test.ts using temp directory fixtures.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Key source files:
@src/core/rollback.ts
@src/core/__tests__/rollback.test.ts
@src/adapters/__tests__/skills.test.ts
@src/adapters/claude-code.ts
@src/adapters/base.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix Date.now() collision in createBackup</name>
  <files>src/core/rollback.ts, src/core/__tests__/rollback.test.ts</files>
  <action>
**Problem:** `createBackup` in `src/core/rollback.ts` line 31 uses `Date.now()` for backup filenames:
```typescript
const backupFileName = `.acsync-backup-${Date.now()}-${file_}`;
```
When two backups are created within the same millisecond (common in tests), the second overwrites the first, causing the "processes backups in reverse order" test to fail — it expects v1 but gets v2 because backup1 was silently overwritten by backup2.

**Fix:** Add a module-level monotonic counter to guarantee uniqueness:

```typescript
let backupCounter = 0;

// In createBackup:
const backupFileName = `.acsync-backup-${Date.now()}-${backupCounter++}-${file_}`;
```

This is the simplest fix (Claude's discretion per CONTEXT.md). The counter resets per process, which is fine — backups are ephemeral (cleaned up after push completes).

**Verify the test:**
The failing test at rollback.test.ts:167-180 creates two backups of the same file rapidly. With the counter suffix, backup1 gets `-0-` and backup2 gets `-1-`, so they never collide. Restore order (reverse) then correctly restores b2 first (v2→v1), then b1 (v1), leaving final content as "v1".

No changes needed to rollback.test.ts — the test logic is correct, only the production code had the bug.
  </action>
  <verify>
`bun test src/core/__tests__/rollback.test.ts` — all tests pass including "processes backups in reverse order".
  </verify>
  <done>
createBackup generates unique filenames via monotonic counter suffix. The rollback reverse-order test passes reliably.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix skills.test.ts host environment dependency</name>
  <files>src/adapters/__tests__/skills.test.ts</files>
  <action>
**Problem:** `skills.test.ts` has 3 failing tests that depend on specific skills (`ralph-tui-create-beads`, `vercel-react-best-practices`) existing in the real `~/.claude/skills/` directory. These skills may not be installed on every machine.

**Fix:** Rewrite tests to use a temp directory with fixture skills instead of reading from host filesystem.

**Implementation:**
1. In `beforeAll`: create a temp dir with `mkdtempSync`, create fixture skill directories:
   - `{tmpdir}/skill-a/SKILL.md` — a simple skill with frontmatter + body, no support files
   - `{tmpdir}/skill-b/SKILL.md` — a skill with support files (`AGENTS.md`, `rules/rule1.md`)
   - `{tmpdir}/.hidden-skill/SKILL.md` — a dot-prefixed dir (should be excluded)

2. For `listExistingSkillNames` and `readSkill` tests, we need to point the adapter at the temp directory instead of `~/.claude/skills/`. The `listExistingSkillNames` and `readSkill` methods on `BaseAdapter` use `this.paths.skills` (from `AdapterPathResolver`).

   **Approach:** Create a `ClaudeCodeAdapter` with a custom `AdapterPathResolver` that points skills to the temp dir. Check how `AdapterPathResolver` works — it takes constructor args or uses defaults. If it doesn't support custom paths, we can:
   - Option A: Test the underlying functions directly with the temp path
   - Option B: Extend or mock the path resolver for test purposes
   
   Since `BaseAdapter` stores `this.paths` as a property set in constructor (`new AdapterPathResolver()`), and `listExistingSkillNames`/`readSkill` reference `this.paths.skills`, the cleanest approach is to read `src/adapters/base.ts` and `src/adapters/path-resolver.ts` to understand the constructor. Then either:
   - Create a test subclass that overrides `this.paths.skills`
   - OR test the skill reading logic with direct path arguments if the methods accept them

   Read those files first to determine the best approach.

3. In `afterAll`: clean up temp dir with `rmSync`.

4. Rewrite all 5 test cases in skills.test.ts:
   - `renderSkill` tests (3 tests in first describe) — these are already pure (pass item object, assert output). Keep as-is, they don't depend on host.
   - `listExistingSkillNames` (2 tests) — use temp dir, assert `skill-a` and `skill-b` present, `.hidden-skill` absent
   - `readSkill` (4 tests) — use temp dir fixtures:
     - `skill-a`: has metadata, no support files
     - `skill-b`: has metadata + support files (AGENTS.md, rules/rule1.md)
     - `skill-b`: SKILL.md excluded from support files
     - `skill-a`: empty supportFiles array

**Key constraint (per CONTEXT.md):** No `zz-` prefix or `zz/` subdirectory in fixtures — reflects current naming conventions.
  </action>
  <verify>
`bun test src/adapters/__tests__/skills.test.ts` — all tests pass. `bun test` — all 435 tests pass with 0 failures.
  </verify>
  <done>
skills.test.ts uses temp directory fixtures. Tests pass on any machine regardless of installed skills. Full suite: 435 pass, 0 fail.
  </done>
</task>

</tasks>

<verification>
- `bun test` — 435 pass, 0 fail
- `bun test src/core/__tests__/rollback.test.ts` — all rollback tests pass
- `bun test src/adapters/__tests__/skills.test.ts` — all skills tests pass
- Run `bun test` 3 times in succession to verify no flaky timing issues
</verification>

<success_criteria>
- Date.now() collision in createBackup fixed permanently
- skills.test.ts fully host-independent (runs on any machine)
- All tests pass: 0 failures across full suite
</success_criteria>

<output>
After completion, create `.planning/phases/04-cli-subcommands-test-fixes/04-02-SUMMARY.md`
</output>
