---
phase: 05-dead-code-cleanup-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/errors.ts
  - src/infra/backup.ts
  - src/infra/hash.ts
  - src/infra/atomic-write.ts
  - src/infra/__tests__/backup.test.ts
  - src/infra/__tests__/hash.test.ts
  - src/infra/__tests__/atomic-write.test.ts
  - src/secrets/env-loader.ts
  - src/secrets/injector.ts
  - src/secrets/__tests__/env-loader.test.ts
  - src/secrets/__tests__/injector.test.ts
  - src/core/rollback.ts
  - src/core/manifest.ts
  - src/core/__tests__/rollback.test.ts
  - src/cli/orchestrator.ts
autonomous: true
requirements: [HYGIENE-DEAD-CODE, HYGIENE-BACKUP]

must_haves:
  truths:
    - "No dead exports remain in the codebase"
    - "atomicWrite has no backup side-effect (pure atomic: temp+fsync+rename)"
    - "Push still works with single rollback-level backup strategy"
    - "All tests pass after cleanup"
  artifacts:
    - path: "src/infra/atomic-write.ts"
      provides: "Pure atomic write without backup"
      contains: "export async function atomicWrite"
    - path: "src/errors.ts"
      provides: "Only used error classes remain"
  key_links:
    - from: "src/infra/atomic-write.ts"
      to: "src/errors.ts"
      via: "AtomicWriteError import"
      pattern: "import.*AtomicWriteError"
    - from: "src/cli/orchestrator.ts"
      to: "src/infra/atomic-write.ts"
      via: "atomicWrite call without backupDir"
      pattern: "atomicWrite\\(op\\.targetPath, content\\)"
---

<objective>
Remove all dead exports and consolidate to a single backup strategy.

Purpose: Eliminate dead code (12 exports identified in v1 audit) and remove the double-backup problem where atomicWrite creates per-file backups AND push creates rollback-level backups.
Output: Cleaned modules with no dead exports, atomicWrite as pure atomic write (no backup side-effect), single rollback-level backup strategy.
</objective>

<execution_context>
@/Users/m332023/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/m332023/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/errors.ts
@src/infra/backup.ts
@src/infra/hash.ts
@src/infra/atomic-write.ts
@src/secrets/env-loader.ts
@src/secrets/injector.ts
@src/core/rollback.ts
@src/core/manifest.ts
@src/cli/orchestrator.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove dead exports and their tests</name>
  <files>
    src/errors.ts
    src/infra/backup.ts
    src/infra/hash.ts
    src/infra/__tests__/backup.test.ts
    src/infra/__tests__/hash.test.ts
    src/secrets/env-loader.ts
    src/secrets/injector.ts
    src/secrets/__tests__/env-loader.test.ts
    src/secrets/__tests__/injector.test.ts
  </files>
  <action>
    Delete the following dead exports AND their implementations (git preserves history):

    **src/infra/backup.ts:** Delete `pruneBackups` and `createBackupDir` functions entirely. Keep `backupFile` for now (Task 2 handles its removal from atomicWrite). If backupFile is the only remaining export after pruneBackups/createBackupDir removal, that's fine — Task 2 will address it.

    **src/infra/__tests__/backup.test.ts:** Delete the `pruneBackups` and `createBackupDir` describe blocks. Keep the `backupFile` tests for now.

    **src/infra/hash.ts:** Delete the ENTIRE file — `hashFile` and `hashDirectory` are both dead (orchestrator uses inline `createHash('sha256').update(content, 'utf-8').digest('hex')` via its own `hashContent` function).

    **src/infra/__tests__/hash.test.ts:** Delete the ENTIRE test file.

    **src/secrets/env-loader.ts:** Delete the ENTIRE file — `loadSecrets` is dead. Phase 3 decided CLIs resolve env vars natively; no secret injection happens.

    **src/secrets/__tests__/env-loader.test.ts:** Delete the ENTIRE test file.

    **src/secrets/injector.ts:** Delete the ENTIRE file — `injectSecrets` and `redactSecrets` are dead per same Phase 3 decision.

    **src/secrets/__tests__/injector.test.ts:** Delete the ENTIRE test file.

    **src/errors.ts:** Delete these unused exports:
    - `SecretError` class (dead — no secret injection)
    - `DiffError` class — verify it's not imported anywhere first (grep `DiffError` in src/ excluding errors.ts and tests). If imported, keep it.
    - `shouldRollback` function (never imported outside errors.ts)
    - `isSyncError` function (only used by getErrorSeverity which is also dead)
    - `getErrorSeverity` function (never imported outside errors.ts)
    Keep: `ErrorSeverity`, `SyncError`, `AtomicWriteError`, `HashError`, `BackupError`, `ParseError`, `ManifestError`, `RollbackError` — these ARE imported by other modules.

    **After deletion:** Check if `src/secrets/` directory has any remaining non-test files besides `env-var-transformer.ts`. If env-var-transformer.ts is the only file, that's fine — it's used by adapters.

    Do NOT delete test files that test code that still exists. Only delete tests for removed code.
  </action>
  <verify>
    Run `bun test` — all remaining tests pass. Grep for removed export names across src/ (excluding __tests__/) to confirm no broken imports.
  </verify>
  <done>
    pruneBackups, createBackupDir, hashFile, hashDirectory, loadSecrets, injectSecrets, redactSecrets, SecretError, shouldRollback, isSyncError, getErrorSeverity removed. DiffError removed if unused (or kept if wired). All remaining tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove backup from atomicWrite and update all callers</name>
  <files>
    src/infra/atomic-write.ts
    src/infra/backup.ts
    src/infra/__tests__/atomic-write.test.ts
    src/infra/__tests__/backup.test.ts
    src/core/rollback.ts
    src/core/manifest.ts
    src/core/__tests__/rollback.test.ts
    src/cli/orchestrator.ts
  </files>
  <action>
    **Per CONTEXT.md decision:** Remove per-file backup from atomicWrite. Keep atomic semantics (temp + fsync + rename). No backup copy.

    **src/infra/atomic-write.ts:**
    - Remove the `backupDir` parameter from `atomicWrite(targetPath, content, backupDir)` → `atomicWrite(targetPath, content)`
    - Remove the `import { backupFile } from './backup'` line
    - Remove the `await backupFile(targetPath, backupDir)` call
    - Keep: mkdir, writeFile to tmp, open+sync+close, rename. Keep AtomicWriteError wrapping.

    **src/infra/backup.ts:**
    - After removing backupFile import from atomic-write, check if backupFile is imported anywhere else (grep). If nowhere, delete the entire backup.ts file and its test file.
    - If still imported somewhere, keep it.

    **src/infra/__tests__/atomic-write.test.ts:**
    - Update all `atomicWrite(path, content, backupDir)` calls to `atomicWrite(path, content)`
    - Remove any test assertions about backup files being created
    - Remove the backupDir setup/variable if no longer needed

    **src/core/manifest.ts (saveManifest):**
    - Update `atomicWrite(manifestPath, content, backupDir)` → `atomicWrite(manifestPath, content)`
    - Remove the `backupDir` variable (`join(dirname(manifestPath), 'backups')` or similar)

    **src/core/rollback.ts (restoreBackup):**
    - Update `atomicWrite(backup.originalPath, backupContent, backupDir)` → `atomicWrite(backup.originalPath, backupContent)`
    - Remove the backupDir variable

    **Per CONTEXT.md:** Move rollback backup directory from `.acsync/backups/` to `os.tmpdir()`. In `src/core/rollback.ts` `createBackup`:
    - Change backup destination to `join(tmpdir(), 'acsync-rollback-' + Date.now().toString())` or similar using `import { tmpdir } from 'node:os'`
    - Keep the monotonic counter pattern from Phase 4 for collision safety

    **src/cli/orchestrator.ts (runPush):**
    - Remove `const backupDir = join(projectDir, '.acsync', 'backups');` line
    - Update `atomicWrite(op.targetPath, content, backupDir)` → `atomicWrite(op.targetPath, content)`

    **src/core/__tests__/rollback.test.ts:**
    - Update any assertions about backup paths if they reference `.acsync/backups/`
    - Backups should now be in tmpdir-based paths
  </action>
  <verify>
    Run `bun test` — all tests pass. Verify `grep -r 'backupDir' src/infra/atomic-write.ts` returns nothing. Verify `grep -r '\.acsync/backups' src/` returns nothing (backup dir moved to tmpdir).
  </verify>
  <done>
    atomicWrite is pure (temp+fsync+rename, no backup). Single backup strategy via rollback (createBackup in tmpdir). No double-backup on push. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. `bun test` — 0 failures
2. `grep -rn 'pruneBackups\|createBackupDir\|hashFile\|hashDirectory\|loadSecrets\|injectSecrets\|redactSecrets\|SecretError\|shouldRollback\|isSyncError\|getErrorSeverity' src/ --include='*.ts' | grep -v __tests__ | grep -v '.test.ts'` — no matches (all dead exports removed from production code)
3. `grep -rn 'backupDir' src/infra/atomic-write.ts` — no matches
4. `wc -l src/infra/atomic-write.ts` — should be ~35 lines (down from 53)
</verification>

<success_criteria>
- All 12 dead exports removed (or wired in if investigation reveals usage)
- atomicWrite signature is `(targetPath, content)` — no backup parameter
- Rollback backups go to os.tmpdir(), not .acsync/backups/
- Push still works: rollback-level createBackup → atomicWrite → restoreAll on failure
- All tests pass with 0 failures
</success_criteria>

<output>
After completion, create `.planning/phases/05-dead-code-cleanup-integration/05-01-SUMMARY.md`
</output>
